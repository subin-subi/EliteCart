<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-gray-100 pt-16 sm:pt-20">
  <%- include("../partials/nav") %>

  <main class="max-w-7xl mx-auto px-4 py-10 space-y-10">
    <h1 class="mt-16 ml-4 text-3xl md:text-4xl font-extrabold text-black tracking-tight border-b-4 border-black inline-block pb-2 uppercase">
      Checkout
    </h1>

    <!-- === FLEX CONTAINER === -->
    <section class="flex flex-col lg:flex-row gap-8">

      <!-- LEFT: Product Details -->
      <div class="flex-1 bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
        <h2 class="text-2xl font-bold text-black mb-6 border-b pb-2">Order Summary</h2>

        <% if (cart && cart.length > 0) { %>
          <div class="space-y-5">
            <% cart.forEach(item => { %>
              <div class="flex items-center justify-between p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                <div class="flex items-center gap-4">
                  <img src="<%= item.mainImage %>" alt="<%= item.name %>" class="w-20 h-20 object-cover rounded-md shadow-sm">
                  <div>
                    <p class="text-lg font-semibold text-gray-900"><%= item.name %></p>
                    <p class="text-sm text-gray-600">Volume: <%= item.volume %> ml</p>
                    <p class="text-sm text-gray-500">Qty: <%= item.quantity %></p>
                    <p class="text-sm text-gray-800 font-medium">Price: â‚¹<%= item.price.toLocaleString() %></p>
                  </div>
                </div>
                <p class="text-lg font-semibold text-gray-900">â‚¹<%= item.total.toLocaleString() %></p>
              </div>
            <% }) %>
          </div>


<!-- Coupon Section -->
<div class="mt-6 border-t pt-4">
  <h3 class="text-lg font-semibold text-gray-900 mb-3">Apply Coupon</h3>

  <div class="flex flex-col sm:flex-row items-center gap-3">
    <!-- Coupon Dropdown -->
    <select id="couponSelect" class="w-full sm:w-2/3 border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 text-gray-800">
      <option value="">Select a coupon</option>

      <% if (availableCoupons && availableCoupons.length > 0) { %>
        <% availableCoupons.forEach(coupon => { %>
          <option 
            value="<%= coupon.code %>" 
            data-discount="<%= coupon.discountValue %>" 
            data-type="<%= coupon.discountType %>">
            <%= coupon.code %> - 
            <%= coupon.discountValue %>
            <%= coupon.discountType === 'flat' ? '/-' : '%' %> off
          </option>
        <% }) %>
      <% } else { %>
        <option disabled>No coupons available</option>
      <% } %>
    </select>

    <!-- Apply Button -->
    <button id="applyCouponBtn"
      class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 transition">
      Apply
    </button>

    <!-- Remove Button -->
    <button id="removeCouponBtn"
      class="hidden bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition">
      Remove
    </button>
  </div>

  <!-- Coupon message -->
  <p id="couponMessage" class="text-sm mt-2 text-green-600 font-medium hidden"></p>
</div>

<!-- ðŸ’° Price Summary -->
<div class="mt-8 border-t pt-4 space-y-2 text-gray-800">
  <!-- Subtotal -->
  <div class="flex justify-between text-lg">
    <span>Subtotal:</span>
    <span id="subtotalAmount">â‚¹<%= cart.reduce((sum, item) => sum + item.total, 0).toLocaleString() %></span>

  </div>

  <!-- Discount -->
  <div id="discountSection" class="hidden flex justify-between text-lg text-green-700 font-semibold">
    <span>Coupon Discount:</span>
    <span id="discountAmount">- â‚¹0.00</span>
  </div>

  <!-- Shipping -->
  <div class="flex justify-between text-lg">
    <span>Shipping:</span>
    <% if (shippingCost === 0) { %>
      <span id="shippingCost" class="text-green-600 font-semibold">Free</span>
    <% } else { %>
      <span id="shippingCost">â‚¹<%= shippingCost.toLocaleString() %></span>
    <% } %>
  </div>

  <!-- Grand Total -->
  <div class="flex justify-between text-xl font-bold border-t pt-3">
    <span>Grand Total:</span>
    <span id="grandTotal">
      â‚¹<%= (cart.reduce((sum, item) => sum + item.total, 0) + (shippingCost || 0)).toLocaleString() %>
      
     
    </span>
  </div>
</div>


</div>

          </div>
        <% } else { %>
          <p class="text-center text-gray-500 py-10">Your cart is empty.</p>
        <% } %>
      </div>

      <!--  RIGHT: Address + Payment + Button -->
      <div class="flex-1 flex flex-col gap-6">

        <!--  Shipping Address -->
        <section class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-lg font-semibold mb-4 text-gray-800">Shipping Address</h2>

          <% if (addresses && addresses.length > 0) { %>
            <div id="addressContainer" class="flex flex-wrap gap-6"></div>
            <div class="flex justify-center gap-3 mt-4">
              <button id="prevBtn" class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">Prev</button>
              <button id="nextBtn" class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">Next</button>
            </div>
          <% } else { %>
            <div class="bg-red-100 text-red-600 rounded-lg p-4 text-sm">
              No address found. Please add one.
            </div>
          <% } %>

          <div class="mt-6 flex justify-between items-center">
            <button 
              onclick="openAddressModal()" 
              class="bg-green-600 text-white text-sm px-5 py-2 rounded-full hover:bg-green-700 transition"
            >
              + Add New Address
            </button>
          </div>
        </section>

        <!-- ðŸ’³ Payment Options -->
   <section class="bg-white p-6 rounded-lg shadow-md mb-4">
  <h2 class="text-lg font-semibold mb-4 text-gray-800">Payment Method</h2>

  <form id="payment-form" class="space-y-3 flex flex-col">
    <!-- Cash on Delivery -->
    <label for="cod" class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer hover:bg-gray-200 transition">
      <input
        type="radio"
        name="paymentMethod"
        id="cod"
        value="cod"
        class="w-4 h-4 accent-green-600"
        <%- subtotal > 1000 ? "disabled" : "checked" %>
      >
      <span class="font-semibold text-gray-700">Cash on Delivery</span>
    </label>

    <!-- Online Payment (Razorpay) -->
    <label for="razorpayOption" class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer hover:bg-gray-200 transition">
      <input
        type="radio"
        name="paymentMethod"
        id="razorpayOption"
        value="razorpay"
        class="w-4 h-4 accent-green-600"
        <%- subtotal > 1000 ? "checked" : "" %>
      >
      <span class="font-semibold text-gray-700">Online Payment</span>
    </label>

    <!-- Wallet -->
    <label for="walletOption" class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer hover:bg-gray-200 transition">
      <input
        type="radio"
        name="paymentMethod"
        id="walletOption"
        value="wallet"
        class="w-4 h-4 accent-green-600"
      >
      <span class="font-semibold text-gray-700">Wallet</span>
    </label>
  </form>
</section>


        <!--Buy Now Button -->
        <div class="flex justify-center">
          <button 
            class="bg-black text-white text-lg px-10 py-3 rounded-full hover:bg-gray-800 transition w-full"
            onclick="placeOrder()"
          >
            Buy Now
          </button>
        </div>
      </div>

    </section>
  </main>

  <div class="pt-6">
    <%- include("../partials/footer") %>
  </div>

  <%- include('../partials/addressForm') %>

  <!-- Script remains same -->
  

<script>
let selectedAddressId = null;

function openAddressModal() {
  document.getElementById('addAddressModal').classList.remove('hidden');
}

const addresses = <%- JSON.stringify(addresses || []) %>;
const container = document.getElementById('addressContainer');
const itemsPerPage = 2;
let currentPage = 1;

function renderAddresses() {
  container.innerHTML = '';
  const ordered = [...addresses].reverse();
  const visible = ordered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
  if (selectedAddressId) {
  const radio = document.querySelector(`input[value='${selectedAddressId}']`);
  if (radio) {
    radio.checked = true;
    const selectedCard = radio.closest('div.relative');
    selectedCard.classList.add('border-green-600', 'bg-green-50');
  }
}


  visible.forEach(addr => {
    const div = document.createElement('div');
    div.className = `
      relative bg-[#e6f2ef] rounded-lg p-4 w-[45%] shadow-md 
      hover:shadow-lg transition border-2 border-transparent
    `;
    div.innerHTML = `
      <div class="absolute top-3 right-3">
        <input 
          type="radio" 
          name="selectedAddress" 
          value="${addr._id}" 
          onchange="window.selectAddress('${addr._id}')"
          class="w-4 h-4 cursor-pointer accent-green-600"
        >
      </div>
      <div class="text-sm leading-6 text-gray-700 mt-3">
        <p class="font-semibold">${addr.name}</p>
        <p>${addr.houseName}, ${addr.street}</p>
        <p>${addr.city}, ${addr.state}, ${addr.country}</p>
        <p>PIN: ${addr.pincode}</p>
        <p>Contact: ${addr.mobile}</p>
      </div>
      <button 
        onclick='editAddress(${JSON.stringify(addr)})'
        class="absolute bottom-3 right-3 bg-black text-white text-xs px-4 py-1 rounded-full hover:bg-gray-800 transition"
      >
        Edit
      </button>
    `;
    container.appendChild(div);
  });
}

document.getElementById('nextBtn').addEventListener('click', () => {
  if (currentPage * itemsPerPage < addresses.length) {
    currentPage++;
    renderAddresses();
  }
});

document.getElementById('prevBtn').addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderAddresses();
  }
});

renderAddresses();

async function selectAddress(addressId) {
  selectedAddressId = addressId;
  document.querySelectorAll('#addressContainer > div').forEach(div => {
    div.classList.remove('border-green-600', 'bg-green-50');
    div.classList.add('border-transparent');
  });

  const selectedCard = document.querySelector(`input[value='${addressId}']`).closest('div.relative');
  if (selectedCard) {
    selectedCard.classList.add('border-green-600', 'bg-green-50');
  }

  try {
    const res = await axios.post('/select-address', { addressId });

    if (res.data.success) showToast('âœ… Address selected successfully!', 'success');
  } catch (err) {
     console.error(err);
      showToast('âŒ Failed to select address.', 'error');
  }
}



function showToast(message, type = 'success') {
  // Create toast div
  const toast = document.createElement('div');
  toast.textContent = message;

  // Style for toast
  toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded-md shadow-lg text-white text-sm transition-all duration-500 z-50 ${
    type === 'success' ? 'bg-green-600' : 'bg-red-600'
  }`;

  document.body.appendChild(toast);

  // Remove after 3 seconds
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

///////////////////////////////coupon adding ///////////////////////////////////



document.addEventListener("DOMContentLoaded", () => {
  const applyBtn = document.getElementById("applyCouponBtn");
  const removeBtn = document.getElementById("removeCouponBtn");
  const couponSelect = document.getElementById("couponSelect");
  const message = document.getElementById("couponMessage");
  const discountSection = document.getElementById("discountSection");
  const discountAmount = document.getElementById("discountAmount");
  const totalElement = document.getElementById("grandTotal");

  let grandTotal = <%= cart.reduce((sum, item) => sum + item.total, 0) + (shippingCost || 0) %>;
  let currentDiscount = 0;
  let finalTotal = grandTotal;

  const currentPage = window.location.pathname;

  //  Check for saved coupon in sessionStorage
  const savedCoupon = JSON.parse(sessionStorage.getItem("appliedCoupon") || "{}");

  //  Only restore if same page
  if (savedCoupon.page === currentPage) {
    applyCouponLogic(savedCoupon.couponCode, savedCoupon.discountValue, savedCoupon.discountType);
    setSelectedCoupon(savedCoupon.couponCode);
  } else {
    // Clear if coupon was for another route
    sessionStorage.removeItem("appliedCoupon");
  }

  //  Function to set dropdown value
  function setSelectedCoupon(code) {
    for (let i = 0; i < couponSelect.options.length; i++) {
      if (couponSelect.options[i].value === code) {
        couponSelect.selectedIndex = i;
        break;
      }
    }
  }

  //  Function to apply coupon
  function applyCouponLogic(code, discountValue, discountType) {
    discountValue = parseFloat(discountValue || 0);
    currentDiscount =
      discountType === "percentage"
        ? Math.floor((grandTotal * discountValue) / 100)
        : discountValue;

    if (currentDiscount > grandTotal) currentDiscount = grandTotal;

    finalTotal = grandTotal - currentDiscount;
    discountAmount.textContent = `- â‚¹${currentDiscount.toFixed(2)}`;
    discountSection.classList.remove("hidden");

    message.textContent = `Coupon "${code}" applied successfully!`;
    message.classList.remove("hidden", "text-red-600");
    message.classList.add("text-green-600");

    applyBtn.classList.add("hidden");
    removeBtn.classList.remove("hidden");

    totalElement.textContent = `â‚¹${finalTotal.toFixed(2)}`;
  }

  // Apply button click
  applyBtn.addEventListener("click", () => {
    const selected = couponSelect.options[couponSelect.selectedIndex];
    const code = selected.value;
    const discountValue = selected.dataset.discount;
    const discountType = selected.dataset.type;

    if (!code) {
      message.textContent = "Please select a coupon.";
      message.classList.remove("hidden", "text-green-600");
      message.classList.add("text-red-600");
      return;
    }

    applyCouponLogic(code, discountValue, discountType);

    // Store only for current checkout page
    sessionStorage.setItem(
      "appliedCoupon",
      JSON.stringify({ page: currentPage, couponCode: code, discountValue, discountType })
    );
  });

  removeBtn.addEventListener("click", () => {
    currentDiscount = 0;
    finalTotal = grandTotal;
    sessionStorage.removeItem("appliedCoupon");

    discountSection.classList.add("hidden");
    message.textContent = "Coupon removed successfully!";
    message.classList.remove("hidden", "text-red-600");
    message.classList.add("text-green-600");

    removeBtn.classList.add("hidden");
    applyBtn.classList.remove("hidden");
    couponSelect.value = "";

    totalElement.textContent = `â‚¹${grandTotal.toFixed(2)}`;
  });

  // âœ… Optional: Auto-clear coupon when user leaves checkout route
  window.addEventListener("beforeunload", () => {
    const path = window.location.pathname;
    if (!path.includes("checkout")) {
      sessionStorage.removeItem("appliedCoupon");
    }
  });
});


///////////////////////////////////checkout ........../////////////////////////////////

async function placeOrder() {
  const cart = <%- JSON.stringify(cart) %>;

  
 const selectedAddress = document.querySelector("input[name='selectedAddress']:checked");
const selectedAddressId = selectedAddress ? selectedAddress.value : null;

  const selectedPayment = document.querySelector("input[name=paymentMethod]:checked");

  
  // ======= VALIDATION =======
  if (!selectedAddressId) {
    showToast("Please select an address before placing the order.", "warning");
    return;
  }

  if (!selectedPayment) {
    showToast("Please select a payment method.", "warning");
    return;
  }

  const paymentMethod = selectedPayment.value;
  const couponSelect = document.getElementById("couponSelect");
  const coupon = couponSelect ? couponSelect.value.trim() : "";

  // ======= COD PAYMENT =======
if (paymentMethod === "cod") {
  try {
    console.log("COD order payload:", { cart, selectedAddressId, paymentMethod, coupon });

    const { data } = await  axios.post("/checkout/order-cod", {
      cart,
      selectedAddressId,
      paymentMethod,
      coupon,
    });

    if (data.success) {
      showToast(data.message, "success");
      sessionStorage.removeItem("coupon");
      setTimeout(() => {
        window.location.href = data.redirect;
      }, 2000);
    } else {
      showToast(data.message || "Order failed.", "danger");
    }
  } catch (err) {
    console.error("Error placing order:", err);
    showToast("Something went wrong. Please try again.", "danger");
  }
}

  // ======= RAZORPAY PAYMENT =======
  else if (paymentMethod === "razorpay") {
    try {
      // Get the current grand total from the page
      const grandTotalElement = document.getElementById("grandTotal");
      const grandTotalText = grandTotalElement.textContent.replace(/[â‚¹,\s]/g, '');
      const grandTotal = parseFloat(grandTotalText) || 0;

      const res = await fetch("/create-razorpay-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cart, selectedAddressId, paymentMethod, coupon }),
      });

      const data = await res.json();

      if (data.success) {
        const { order, tempOrderId } = data;

        // Validate tempOrderId exists
        if (!tempOrderId) {
          showToast("Error: Order ID not found. Please try again.", "danger");
          return;
        }

        const options = {
          key: "<%= process.env.RAZORPAY_KEY_ID %>",
          amount: order.amount,
          currency: order.currency,
          name: "EliteCart",
          description: "Order Payment",
          order_id: order.id,
          handler: async function (response) {
            try {
              const verifyRes = await fetch("/verify-razorpay-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  orderId: order.id,
                  paymentId: response.razorpay_payment_id,
                  signature: response.razorpay_signature,
                  tempOrderId,
                }),
              });

              const verifyData = await verifyRes.json();

              if (verifyData.success) {
                sessionStorage.removeItem("coupon");
                window.location.href = `/oder-status/${verifyData.orderId}`;
              } else {
                // Use tempOrderId if verifyData.orderId is not available
                const orderIdToUse = verifyData.orderId || tempOrderId;
                if (orderIdToUse) {
                  try {
                    await fetch(`/payment-failed/${orderIdToUse}`, { method: "PATCH" });
                  } catch (e) {
                    console.error("Error updating payment status:", e);
                  }
                  window.location.href = `/payment-failed/${orderIdToUse}`;
                } else {
                  showToast("Payment verification failed. Please contact support.", "danger");
                }
              }
            } catch (err) {
              console.error("Payment verification error:", err);
              // Use tempOrderId for error handling
              if (tempOrderId) {
                try {
                  await fetch(`/payment-failed/${tempOrderId}`, { method: "PATCH" });
                } catch (e) {
                  console.error("Error updating payment status:", e);
                }
                window.location.href = `/payment-failed/${tempOrderId}`;
              } else {
                showToast("Payment failed. Please contact support with order details.", "danger");
              }
            }
          },
          prefill: {
            name: "<%= user.name || '' %>",
            email: "<%= user.email || '' %>",
          },
          theme: { color: "#2e0e46" },
          modal: {
            ondismiss: async function () {
              if (tempOrderId) {
                try {
                  await fetch(`/payment-failed/${tempOrderId}`, { method: "PATCH" });
                } catch (e) {
                  console.error("Error updating payment status:", e);
                }
                window.location.href = `/payment-failed/${tempOrderId}`;
              } else {
                showToast("Payment cancelled. Please try again.", "warning");
              }
            },
          },
        };

        const rzp = new window.Razorpay(options);

        rzp.on("payment.failed", async function (response) {
          if (tempOrderId) {
            try {
              await fetch(`/payment-failed/${tempOrderId}`, { method: "PATCH" });
            } catch (e) {
              console.error("Error updating payment status:", e);
            }
            window.location.href = `/payment-failed/${tempOrderId}`;
          } else {
            showToast("Payment failed. Please contact support.", "danger");
          }
        });

        rzp.open();
      } else {
        showToast(data.message || "Unable to create Razorpay order.", "danger");
      }
    } catch (err) {
      console.error("Razorpay error:", err);
      showToast("Some Error in Razorpay", "danger");
    }
  }

  // ======= WALLET PAYMENT =======
  else if (paymentMethod === "wallet") {
    try {
      const res = await fetch("/wallet-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cart, selectedAddressId, paymentMethod, coupon }),
      });

      const data = await res.json();

      if (data.success) {
        showToast(data.message, "success");
        sessionStorage.removeItem("coupon");

        setTimeout(() => {
          window.location.href = data.redirect;
        }, 2000);
      } else {
        showToast(data.message || "Wallet payment failed.", "danger");
      }
    } catch (err) {
      console.error("Error placing order:", err);
      showToast("Something went wrong. Please try again.", "danger");
    }
  }
}




  function showToast(message, type = "info") {
    const icon = type === "success" ? "success"
               : type === "danger" ? "error"
               : type === "warning" ? "warning"
               : "info";

    Swal.fire({
      toast: true,
      position: "top-end",
      icon: icon,
      title: message,
      showConfirmButton: false,
      timer: 2500,
      timerProgressBar: true
    });
  }


</script>

</body>
</html>
