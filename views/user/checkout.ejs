<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-gray-100 pt-16 sm:pt-20">
  <%- include("../partials/nav") %>

  <main class="max-w-7xl mx-auto px-4 py-10 space-y-10">
    <h1 class="mt-16 ml-4 text-3xl md:text-4xl font-extrabold text-black tracking-tight border-b-4 border-black inline-block pb-2 uppercase">
      Checkout
    </h1>

    <!-- === FLEX CONTAINER === -->
    <section class="flex flex-col lg:flex-row gap-8">

      <!-- LEFT: Product Details -->
      <div class="flex-1 bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
        <h2 class="text-2xl font-bold text-black mb-6 border-b pb-2">Order Summary</h2>

        <% if (cart && cart.length > 0) { %>
          <div class="space-y-5">
            <% cart.forEach(item => { %>
              <div class="flex items-center justify-between p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                <div class="flex items-center gap-4">
                  <img src="<%= item.mainImage %>" alt="<%= item.name %>" class="w-20 h-20 object-cover rounded-md shadow-sm">
                  <div>
                    <p class="text-lg font-semibold text-gray-900"><%= item.name %></p>
                    <p class="text-sm text-gray-600">Volume: <%= item.volume %> ml</p>
                    <p class="text-sm text-gray-500">Qty: <%= item.quantity %></p>
                    <p class="text-sm text-gray-800 font-medium">Price: â‚¹<%= item.price.toLocaleString() %></p>
                  </div>
                </div>
                <p class="text-lg font-semibold text-gray-900">â‚¹<%= item.total.toLocaleString() %></p>
              </div>
            <% }) %>
          </div>


<!-- Coupon Section -->
<div class="mt-6 border-t pt-4">
  <h3 class="text-lg font-semibold text-gray-900 mb-3">Apply Coupon</h3>

  <div class="flex flex-col sm:flex-row items-center gap-3">
    <!-- Coupon Dropdown -->
    <select id="couponSelect" class="w-full sm:w-2/3 border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 text-gray-800">
      <option value="">Select a coupon</option>

      <% if (availableCoupons && availableCoupons.length > 0) { %>
        <% availableCoupons.forEach(coupon => { %>
          <option 
            value="<%= coupon.code %>" 
            data-discount="<%= coupon.discountValue %>" 
            data-type="<%= coupon.discountType %>">
            <%= coupon.code %> - 
            <%= coupon.discountValue %>
            <%= coupon.discountType === 'flat' ? '/-' : '%' %> off
          </option>
        <% }) %>
      <% } else { %>
        <option disabled>No coupons available</option>
      <% } %>
    </select>

    <!-- Apply Button -->
    <button id="applyCouponBtn"
      class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 transition">
      Apply
    </button>

    <!-- Remove Button -->
    <button id="removeCouponBtn"
      class="hidden bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition">
      Remove
    </button>
  </div>

  <!-- Coupon message -->
  <p id="couponMessage" class="text-sm mt-2 text-green-600 font-medium hidden"></p>
</div>

<!-- ðŸ’° Price Summary -->
<div class="mt-8 border-t pt-4 space-y-2 text-gray-800">
  <!-- Subtotal -->
  <div class="flex justify-between text-lg">
    <span>Subtotal:</span>
    <span id="subtotalAmount">â‚¹<%= cart.reduce((sum, item) => sum + item.total, 0).toLocaleString() %></span>

  </div>

  <!-- Discount -->
  <div id="discountSection" class="hidden flex justify-between text-lg text-green-700 font-semibold">
    <span>Coupon Discount:</span>
    <span id="discountAmount">- â‚¹0.00</span>
  </div>

  <!-- Shipping -->
  <div class="flex justify-between text-lg">
    <span>Shipping:</span>
    <% if (shippingCost === 0) { %>
      <span id="shippingCost" class="text-green-600 font-semibold">Free</span>
    <% } else { %>
      <span id="shippingCost">â‚¹<%= shippingCost.toLocaleString() %></span>
    <% } %>
  </div>

  <!-- Grand Total -->
  <div class="flex justify-between text-xl font-bold border-t pt-3">
    <span>Grand Total:</span>
    <span id="grandTotal">
      â‚¹<%= (cart.reduce((sum, item) => sum + item.total, 0) + (shippingCost || 0)).toLocaleString() %>
      
     
    </span>
  </div>
</div>


</div>

          </div>
        <% } else { %>
          <p class="text-center text-gray-500 py-10">Your cart is empty.</p>
        <% } %>
      </div>

      <!--  RIGHT: Address + Payment + Button -->
      <div class="flex-1 flex flex-col gap-6">

        <!--  Shipping Address -->
        <section class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-lg font-semibold mb-4 text-gray-800">Shipping Address</h2>

          <% if (addresses && addresses.length > 0) { %>
            <div id="addressContainer" class="flex flex-wrap gap-6"></div>
            <div class="flex justify-center gap-3 mt-4">
              <button id="prevBtn" class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">Prev</button>
              <button id="nextBtn" class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">Next</button>
            </div>
          <% } else { %>
            <div class="bg-red-100 text-red-600 rounded-lg p-4 text-sm">
              No address found. Please add one.
            </div>
          <% } %>

          <div class="mt-6 flex justify-between items-center">
            <button 
              onclick="openAddressModal()" 
              class="bg-green-600 text-white text-sm px-5 py-2 rounded-full hover:bg-green-700 transition"
            >
              + Add New Address
            </button>
          </div>
        </section>

        <!-- ðŸ’³ Payment Options -->
   <section class="bg-white p-6 rounded-lg shadow-md mb-4">
  <h2 class="text-lg font-semibold mb-4 text-gray-800">Payment Method</h2>

  <form id="payment-form" class="space-y-3 flex flex-col">
    <!-- Cash on Delivery -->
    <label for="cod" class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer hover:bg-gray-200 transition">
      <input
        type="radio"
        name="paymentMethod"
        id="cod"
        value="cod"
        class="w-4 h-4 accent-green-600"
        <%- subtotal > 1000 ? "disabled" : "checked" %>
      >
      <span class="font-semibold text-gray-700">Cash on Delivery</span>
    </label>

    <!-- Online Payment (Razorpay) -->
    <label for="razorpayOption" class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer hover:bg-gray-200 transition">
      <input
        type="radio"
        name="paymentMethod"
        id="razorpayOption"
        value="razorpay"
        class="w-4 h-4 accent-green-600"
        <%- subtotal > 1000 ? "checked" : "" %>
      >
      <span class="font-semibold text-gray-700">Online Payment</span>
    </label>

    <!-- Wallet -->
    <label for="walletOption" class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer hover:bg-gray-200 transition">
      <input
        type="radio"
        name="paymentMethod"
        id="walletOption"
        value="wallet"
        class="w-4 h-4 accent-green-600"
      >
      <span class="font-semibold text-gray-700">Wallet</span>
    </label>
  </form>
</section>


        <!--Buy Now Button -->
        <div class="flex justify-center">
          <button 
            class="bg-black text-white text-lg px-10 py-3 rounded-full hover:bg-gray-800 transition w-full"
            onclick="placeOrder()"
          >
            Buy Now
          </button>
        </div>
      </div>

    </section>
  </main>

  <div class="pt-6">
    <%- include("../partials/footer") %>
  </div>

  <%- include('../partials/addressForm') %>

  <!-- Script remains same -->
  

<script src="/javascript/user/checkout.js"></script>
</body>
</html>
