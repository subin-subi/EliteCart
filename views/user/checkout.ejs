<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-100 pt-16 sm:pt-20">
  <%- include("../partials/nav") %>

  <main class="max-w-7xl mx-auto px-4 py-10 space-y-10">

    <!-- ========== PRODUCT + PAYMENT SECTION ========== -->
    <section class="flex flex-col lg:flex-row gap-8 bg-white rounded-lg p-6 shadow-md">
      
      <!-- üõí Product Details -->
      <div class="flex-1 flex items-center gap-6 border-r border-gray-200 pr-6">
        <% if (singleProduct) { %>
          <img 
            src="<%= singleProduct.mainImage %>" 
            alt="<%= singleProduct.name %>" 
            class="w-36 h-36 object-cover rounded-lg shadow"
          >
          <div class="space-y-1">
            <h2 class="text-xl font-semibold text-gray-800"><%= singleProduct.name %></h2>
            <p class="text-gray-600 text-sm">Volume: <%= singleProduct.volume %> ml</p>
            <p class="text-gray-600 text-sm">Price: ‚Çπ<%= singleProduct.price %></p>
          </div>
        <% } else if (cart && cart.length > 0) { %>
          <div class="space-y-3">
            <% cart.forEach(item => { %>
              <div class="flex items-center gap-4">
                <img src="<%= item.mainImage %>" alt="<%= item.name %>" class="w-20 h-20 object-cover rounded-md">
                <div>
                  <p class="text-base font-semibold"><%= item.name %></p>
                  <p class="text-sm text-gray-500">Volume: <%= item.volume %> ml</p>
                  <p class="text-sm text-gray-400">(x<%= item.quantity %>)</p>
                </div>
                <p class="ml-auto font-semibold">‚Çπ<%= item.total %></p>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>

      <!-- üí≥ Payment Methods -->
      <div class="flex-1">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Payment Options</h2>
        <form id="payment-form" class="space-y-3 flex flex-col">
          <label class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer">
            <input type="radio" name="payment" value="UPI" class="w-4 h-4 accent-green-600">
            <span>UPI</span>
          </label>
          <label class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer">
            <input type="radio" name="payment" value="Wallet" class="w-4 h-4 accent-green-600">
            <span>Wallet</span>
          </label>
          <label class="flex items-center gap-3 bg-gray-100 rounded-full px-5 py-2 cursor-pointer">
            <input type="radio" name="payment" value="COD" checked class="w-4 h-4 accent-green-600">
            <span>Cash On Delivery</span>
          </label>
        </form>
      </div>
    </section>

    <!-- ========== ADDRESS SECTION ========== -->
    <section class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold mb-4">Shipping Address</h2>

      <% if (addresses && addresses.length > 0) { %>
        <div id="addressContainer" class="flex flex-wrap gap-6"></div>

        <!-- Pagination Controls -->
        <div class="flex justify-center gap-3 mt-4">
          <button id="prevBtn" class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">Prev</button>
          <button id="nextBtn" class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">Next</button>
        </div>
      <% } else { %>
        <div class="bg-red-100 text-red-600 rounded-lg p-4 w-[50%]">
          No address found. Please add one.
        </div>
      <% } %>

      <!-- Add New Address Button -->
      <div class="mt-6 flex justify-between items-center">
        <button 
          onclick="openAddressModal()" 
          class="bg-green-600 text-white text-sm px-5 py-2 rounded-full hover:bg-green-700 transition"
        >
          + Add New Address
        </button>
      </div>
    </section>

    
    <div class="flex justify-center">
      <button 
        class="bg-black text-white text-lg px-10 py-3 rounded-full hover:bg-gray-800 transition"
        onclick="submitCheckout()"
      >
        Buy Now
      </button>
    </div>
  </main>

  <div class="pt-6">
    <%- include("../partials/footer") %>
  </div>

  <%- include('../partials/addressForm') %>

  
<script>
let selectedAddressId = null;

function openAddressModal() {
  document.getElementById('addAddressModal').classList.remove('hidden');
}

const addresses = <%- JSON.stringify(addresses || []) %>;
const container = document.getElementById('addressContainer');
const itemsPerPage = 2;
let currentPage = 1;

function renderAddresses() {
  container.innerHTML = '';
  const ordered = [...addresses].reverse();
  const visible = ordered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

  visible.forEach(addr => {
    const div = document.createElement('div');
    div.className = `
      relative bg-[#e6f2ef] rounded-lg p-4 w-[45%] shadow-md 
      hover:shadow-lg transition border-2 border-transparent
    `;
    div.innerHTML = `
      <div class="absolute top-3 right-3">
        <input 
          type="radio" 
          name="selectedAddress" 
          value="${addr._id}" 
          onchange="selectAddress('${addr._id}')"
          class="w-4 h-4 cursor-pointer accent-green-600"
        >
      </div>
      <div class="text-sm leading-6 text-gray-700 mt-3">
        <p class="font-semibold">${addr.name}</p>
        <p>${addr.houseName}, ${addr.street}</p>
        <p>${addr.city}, ${addr.state}, ${addr.country}</p>
        <p>PIN: ${addr.pincode}</p>
        <p>Contact: ${addr.mobile}</p>
      </div>
      <button 
        onclick='editAddress(${JSON.stringify(addr)})'
        class="absolute bottom-3 right-3 bg-black text-white text-xs px-4 py-1 rounded-full hover:bg-gray-800 transition"
      >
        Edit
      </button>
    `;
    container.appendChild(div);
  });
}

document.getElementById('nextBtn').addEventListener('click', () => {
  if (currentPage * itemsPerPage < addresses.length) {
    currentPage++;
    renderAddresses();
  }
});

document.getElementById('prevBtn').addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderAddresses();
  }
});

renderAddresses();

async function selectAddress(addressId) {
  selectedAddressId = addressId;
  document.querySelectorAll('#addressContainer > div').forEach(div => {
    div.classList.remove('border-green-600', 'bg-green-50');
    div.classList.add('border-transparent');
  });

  const selectedCard = document.querySelector(`input[value='${addressId}']`).closest('div.relative');
  if (selectedCard) {
    selectedCard.classList.add('border-green-600', 'bg-green-50');
  }

  try {
    const res = await axios.post('/select-address', { addressId });
    if (res.data.success) alert('‚úÖ Address selected successfully!');
  } catch (err) {
    console.error(err);
    alert('‚ùå Failed to select address.');
  }
}

async function submitCheckout() {
  const payment = document.querySelector('input[name="payment"]:checked').value;
  if (!selectedAddressId) {
    alert("‚ö†Ô∏è Please select a shipping address first.");
    return;
  }

  const body = {
    paymentMethod: payment,
    addressId: selectedAddressId,
    productIds: "<%= productIds %>",
    variantIds: "<%= variantIds %>",
    total: <%= total %>
  };

  try {
    const res = await axios.post('/place-order', body);
    if (res.data.success) {
      alert("‚úÖ Order placed successfully!");
      window.location.href = "/order-success";
    } else {
      alert("‚ùå " + res.data.message);
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå Failed to place order.");
  }
}
</script>

</body>
</html>
