<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Address | Elite Cart</title>
  <link rel="stylesheet" href="/css/output.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Navbar -->
  <%- include("../partials/nav") %>

  <div class="flex flex-1 mt-20 px-4 md:px-10 gap-6">

    <!-- Sidebar -->
    <div class="hidden md:block">
      <%- include("../partials/userSidebar") %>
    </div>

    <!-- Address Section -->
    <div class="flex-1 max-w-3xl mx-auto my-[60px] px-4 gap-6">
      <div class="bg-white border rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Address</h2>
        <p class="text-sm text-gray-500 text-center mb-6">
          Save your address for faster checkout experience.
        </p>

        <!-- Add Address Button (Always Visible) -->
        <div class="text-center mb-4">
          <button onclick="openAddressModal()" 
            class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition">
            + Add New Address
          </button>
        </div>

        <!-- Address List -->
        <div id="addressList" class="flex flex-col gap-4">
          <% if (addresses && addresses.length > 0) { %>
            <% addresses.forEach(addr => { %>
              <div class="bg-gray-50 border rounded-lg p-4 shadow flex flex-col gap-2">
                <div class="flex justify-between items-center">
                  <h3 class="font-semibold text-lg"><%= addr.name %></h3>
                 <label class="inline-flex items-center cursor-pointer">
  <input 
    type="checkbox" 
    class="defaultToggle" 
    data-id="<%= addr._id %>" 
    <%= addr.isDefault ? "checked" : "" %>>
  <span class="ml-2 text-green-600 font-bold">Default</span>
</label>

                </div>
                <p><%= addr.houseName %>, <%= addr.street %>, <%= addr.city %>, <%= addr.state %>, <%= addr.pincode %>, <%= addr.country %></p>
                <p>Mobile: <%= addr.mobile %></p>
                <div class="mt-4 flex justify-end gap-2">
     <button 
  class="px-4 py-1 bg-gray-200 rounded hover:bg-gray-300 editBtn"
  onclick='editAddress(<%- JSON.stringify(addr) %>)'>
  Edit
</button>

                 <button 
  class="blockBtn px-3 py-1 rounded-md text-white text-sm transition 
    <%= addr.isBlocked ? "bg-green-500 hover:bg-green-600" : "bg-red-500 hover:bg-red-600" %>"
  onclick="toggleBlockAddress('<%= addr._id %>', <%= addr.isBlock %>) "
>  
  <span class="material-icons text-sm mr-1">
    <%= addr.isBlock ? "check_circle" : "block" %> 
  </span>
  <%= addr.isBlock ? "Unblock" : "Block" %>
</button>

                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-center text-gray-500">No addresses found. Add a new address above.</p>
          <% } %>
        </div>


<div class="mt-4 flex justify-center gap-2">
  <% if (currentPage > 1) { %>
    <a href="?page=<%= currentPage - 1 %>" 
       class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Previous</a>
  <% } %>

  <% for (let i = 1; i <= totalPages; i++) { %>
    <a href="?page=<%= i %>" 
       class="px-3 py-1 rounded <%= i === currentPage ? 'bg-black text-white' : 'bg-gray-200 hover:bg-gray-300' %>">
      <%= i %>
    </a>
  <% } %>

  <% if (currentPage < totalPages) { %>
    <a href="?page=<%= currentPage + 1 %>" 
       class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>
  <% } %>
</div>



      </div>
    </div>
  </div>



  <!-- Footer -->
  <%- include('../partials/footer') %>

  <!-- Address Form Modal -->
  <%- include('../partials/addressForm') %>
  

  <script>
    const addressList = document.getElementById("addressList");

    function openAddressModal() {
      document.getElementById('addAddressModal').classList.remove('hidden');
    }
    

    
      
function toggleBlockAddress(addressId, currentlyBlocked) {
  const action = currentlyBlocked ? "unblock" : "block";

  Swal.fire({
    title: `Are you sure you want to ${action} this address?`,
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: currentlyBlocked ? "#28a745" : "#d33",
    cancelButtonColor: "#6c757d",
    confirmButtonText: `Yes, ${action} it!`
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/${action}-address/${addressId}`, { method: "PATCH" })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
           
            Swal.fire({
              toast: true,
              position: "top-end",
              icon: "success",
              title: `Address ${currentlyBlocked ? "unblocked" : "blocked"} successfully!`,
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true
            });

            setTimeout(() => location.reload(), 2000);  
          } else {
            
            Swal.fire({
              toast: true,
              position: "top-end",
              icon: "error",
              title: data.message || `Failed to ${action} address`,
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true
            });
          }
        })
        .catch(() => {
          Swal.fire({
            toast: true,
            position: "top-end",
            icon: "error",
            title: `Error trying to ${action} address`,
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
          });
        });
    }
  });
}
//////////////////////////default ///////////////////////////////////////////

 document.querySelectorAll(".defaultToggle").forEach(toggle => {
  toggle.addEventListener("change", async (e) => {
    const selectedToggle = e.target;
    const addressId = selectedToggle.getAttribute("data-id");

    if (!addressId || addressId === "undefined" || addressId === "null") {
      console.error("Address ID is missing!");
      selectedToggle.checked = false;

      Swal.fire({
        toast: true,
        position: "top-end",
        icon: "error",
        title: "Invalid address. Cannot set default!",
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
      });

      return;
    }

    if (selectedToggle.checked) {
      try {
        await axios.post(`/set-default-address/${addressId}`);

        // Uncheck other toggles
        document.querySelectorAll(".defaultToggle").forEach(cb => {
          if (cb !== selectedToggle) cb.checked = false;
        });

        
        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: "Default address set successfully!",
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true,
        });

      } catch (err) {
        console.error("Error setting default address:", err);
        selectedToggle.checked = false;

       
        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "error",
          title: "Failed to set default address!",
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true,
        });
      }

    } else {
      selectedToggle.checked = true;
    }
  });
});

  
  </script>
</body>
</html>
