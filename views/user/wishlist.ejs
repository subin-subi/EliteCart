<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wishlist | Elite Cart</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- Font Awesome -->
 <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  referrerpolicy="no-referrer"
/>

</head>

<body class="bg-gray-100 pt-16 sm:pt-20 min-h-screen flex flex-col">
  

   <%- include("../partials/pageLoader") %>
  <!-- Navbar -->
  <%- include('../partials/nav') %>

  <!-- Main Section -->
  <main class="max-w-7xl mx-auto px-4 py-16 flex-1 flex flex-col items-center justify-center">

    <% if (!wishlist || wishlist.items.length === 0) { %>
      <!-- ðŸ©· Empty Wishlist -->
      <div class="flex flex-col items-center justify-center text-center space-y-6">
        <img 
          src="/images/wh.jpeg" 
          alt="Empty Wishlist" 
          class="w-64 h-64 object-contain opacity-90"
        >
        <h2 class="text-2xl font-bold text-red-600">Your Wishlist is Empty!</h2>
        <a href="/product" 
          class="bg-indigo-600 text-white text-sm px-6 py-2 rounded-full hover:bg-indigo-700 transition">
          Continue Shopping
        </a>
      </div>

    <% } else { %>
      <!-- ðŸ› Wishlist Items -->
      <h2 class="text-3xl font-bold mb-10 text-gray-800 text-center">Your Wishlist</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 w-full">
<% wishlist.items.forEach(item => { 
   const variant = item.variant || 
                  (item.productId?.variants && item.productId.variants.length > 0 
                    ? item.productId.variants[0] 
                    : null);

%>

  <div class="bg-white shadow-lg rounded-2xl overflow-hidden hover:shadow-2xl transition transform hover:-translate-y-1 relative group">

    <!-- Remove from Wishlist -->
    <form action="/wishlist/remove/<%= item.productId._id %>" method="POST" 
          class="absolute top-3 right-3 z-10">
      <button type="submit" 
              class="bg-white rounded-full p-2 shadow-md hover:bg-pink-100 transition">
        <i class="fa-solid fa-heart-crack text-pink-600 text-lg"></i>
      </button>
    </form>

    <!-- Product Image -->
    <div class="relative w-full h-60">
      <img 
        src="<%= variant?.mainImage || '/images/placeholder.jpg' %>" 
        alt="<%= item.productId?.name %>" 
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
      >
    </div>

    <!-- Product Info -->
    <div class="p-4 flex flex-col justify-between min-h-[150px]">
      <div>
        <h3 class="font-semibold text-gray-800 text-lg truncate">
          <%= item.productId?.name %>
        </h3>
        
        <% if (item.productId?.category?.name) { %>
          <p class="text-sm text-gray-500 mt-1">
            <%= item.productId.category.name %>
          </p>
        <% } %>
      </div>

    <div class="flex items-center justify-between mt-3">
  <% if (item.variant) { %>
    <% if (item.variant.discountPrice && item.variant.discountPrice < item.variant.price) { %>
      <p class="text-lg font-semibold text-red-600">
        â‚¹<%= item.variant.discountPrice.toLocaleString() %>
      </p>
      <p class="text-sm text-gray-500 line-through ml-2">
        â‚¹<%= item.variant.price.toLocaleString() %>
      </p>
      <span class="text-green-600 text-sm ml-1">
        (<%= Math.round(((item.variant.price - item.variant.discountPrice) / item.variant.price) * 100) %>% OFF)
      </span>
    <% } else { %>
      <p class="text-lg font-semibold text-gray-800">
        â‚¹<%= item.variant.price.toLocaleString() %>
      </p>
    <% } %>
  <% } else { %>
    <p class="text-lg text-gray-500">â€”</p>
  <% } %>
</div>


      <!-- Buttons -->
      <div class="mt-4 grid grid-cols-2 gap-3">
        <a href="/productDetail/<%= item.productId._id %>" 
           class="bg-indigo-600 text-white text-center py-2 rounded-full hover:bg-indigo-700 transition text-sm font-medium">
          View Product
        </a>
<form action="/cart/add-to-wish" method="POST" class="add-to-cart-form">
  <input type="hidden" name="productId" value="<%= item.productId?._id %>">
  <input type="hidden" name="variantId" value="<%= item.variantId || variant?._id %>">



  <button type="submit"
          class="bg-green-600 text-white w-full py-2 rounded-full hover:bg-green-700 transition text-sm font-medium">
    Add to Cart
  </button>
</form>

      </div>
    </div>
  </div>
<% }) %>

</div>
    <% } %>

  </main>

  <!-- Footer -->
  <%- include('../partials/footer') %>
  

  <script>


document.querySelectorAll('.add-to-cart-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const productId = form.querySelector('input[name="productId"]').value;
    const variantId = form.querySelector('input[name="variantId"]').value;

    try {
      const response = await axios.post(form.action, { productId, variantId });
      const result = response.data;

      if (result.success) {
        Swal.fire({
          icon: "success",
          title: result.message,
          toast: true,
          position: "top-end",
          timer: 1500,
          showConfirmButton: false,
          timerProgressBar: true
        });

        // ðŸ”„ Refresh after success
        setTimeout(() => location.reload(), 1500);
      } else {
        Swal.fire({
          icon: "error",
          title: result.message || "Failed to add product",
          toast: true,
          position: "top-end",
          timer: 2000,
          showConfirmButton: false,
          timerProgressBar: true
        });

        // ðŸ”„ Refresh after backend error (non-success)
        setTimeout(() => location.reload(), 2000);
      }

    } catch (error) {
      console.error("Axios error:", error);

      const errMsg =
        error.response?.data?.message || "Something went wrong";

      Swal.fire({
        icon: "error",
        title: errMsg,
        toast: true,
        position: "top-end",
        timer: 2000,
        showConfirmButton: false,
        timerProgressBar: true
      });

      //Refresh after 2 seconds even when Axios error (e.g., 400 Max limit)
      setTimeout(() => location.reload(), 2000);
    }
  });
});

</script> 
</body>

</html>
