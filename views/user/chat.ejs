<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Add this in your layout or EJS head -->
</head>
<body class="h-screen flex items-center justify-center bg-cover bg-center"
  style="background-image: url('https://images.unsplash.com/photo-1507238691740-187a5b1d37b8');">



   <%- include("../partials/pageLoader") %>
<!-- Navbar -->
  <%- include("../partials/nav") %>
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black/50"></div>

  <!-- Chat Support Popup -->
  <div
    id="chatPopup"
    class="relative w-[92%] max-w-sm bg-white rounded-3xl shadow-2xl border border-gray-200 z-50 overflow-hidden"
  >
    <!-- Header -->
    <div class="bg-gradient-to-br from-[#25D366] to-[#128C7E] text-white px-5 py-3 flex justify-between items-center">
      <h4 class="font-semibold text-base flex items-center gap-2">
        <i class="fas fa-comment-dots animate-bounce"></i>
        Chat with Us
      </h4>
      <button class="text-white text-xl hover:scale-110 transition">&times;</button>
    </div>

    <!-- Chat Body -->
    <div id="chatMessages"
      class="p-4 h-[400px] overflow-y-auto flex flex-col gap-3 bg-gradient-to-br from-gray-50 to-white">

      <div class="self-start bg-white text-gray-800 px-4 py-2 rounded-2xl shadow-sm max-w-[80%] border border-gray-200">
        ðŸ‘‹ Hello! How can we assist you today?
      </div>
    </div>

    <!-- Chat Input -->
    <form class="flex border-t border-gray-200 bg-white p-3 gap-2">
      <input
        type="text"
        id="chatInput"
        placeholder="Type your message..."
        class="flex-1 px-4 py-2 rounded-full bg-gray-100 text-sm focus:outline-none focus:ring-2 focus:ring-[#25D366]"
      />
      <button type="submit"
        class="bg-[#25D366] hover:bg-[#1EBE58] text-white px-5 py-2 rounded-full text-sm font-medium shadow-sm">
        Send
      </button>
    </form>
  </div>



        <script src="/socket.io/socket.io.js"></script>

        <Script>

            /////////////////////////////////////////////////chat////////////////////////////////////////

      const socket = io();

      // =========================
      // USER IDENTIFICATION
      // =========================
      const userId =
        "<%= user && user._id ? user._id : '' %>" ||
        localStorage.getItem("guestId") ||
        (() => {
          const id = "guest-" + Math.random().toString(36).substr(2, 9);
          localStorage.setItem("guestId", id);
          return id;
        })();
      const userName = "<%= user && user.name ? user.name : 'Guest' %>";

      console.log("âœ… Chat User:", userId);

      // =========================
      // SOCKET CONNECTION
      // =========================
      socket.emit("join", userId);
      socket.emit("userOnline", { userId });

      // Notify when user leaves
      window.addEventListener("beforeunload", () => {
        socket.emit("userOffline", { userId, userName });
      });

      // =========================
      // TYPING EVENT
      // =========================
      const chatInput = document.getElementById("chatInput");
      if (chatInput) {
        chatInput.addEventListener("input", () => {
          socket.emit("userTyping", { userId, userName });
        });
      }

      // =========================
      // SEND MESSAGE FUNCTION
      // =========================
      function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById("chatInput");
        const messages = document.getElementById("chatMessages");
        const chatPopup = document.getElementById("chatPopup");

        if (!input || !messages) return;

        const text = input.value.trim();
        if (!text) return;

        // Show user message in UI
        const userMsg = document.createElement("div");
        userMsg.className =
          "self-end bg-indigo-100 text-gray-800 px-3 py-2 rounded-lg shadow";
        userMsg.textContent = text;
        messages.appendChild(userMsg);
        messages.scrollTop = messages.scrollHeight;

        // Send to server
        socket.emit("userMessage", {
          userId,
          userName,
          message: text,
          sender: "user",
          timestamp: new Date(),
        });

        input.value = "";
      }

      // =========================
      // RECEIVE ADMIN MESSAGE
      // =========================
      socket.on("newMessage", (msg) => {
        if (msg.sender !== "admin") return;

        const messages = document.getElementById("chatMessages");
        const chatPopup = document.getElementById("chatPopup");
        const chatNotifBadge = document.getElementById("chatNotifBadge");

        const replyDiv = document.createElement("div");
        replyDiv.className =
          "self-start bg-gray-100 text-gray-700 px-3 py-2 rounded-lg shadow";
        replyDiv.textContent = msg.message;
        messages.appendChild(replyDiv);
        messages.scrollTop = messages.scrollHeight;

        // Show badge + toast if chat is hidden
        if (chatPopup?.classList.contains("hidden")) {
          let count = parseInt(chatNotifBadge?.textContent || "0");
          chatNotifBadge.textContent = count + 1;
          chatNotifBadge.classList.remove("hidden");

          showChatToast("New message from support!");

          const audio = new Audio(
            "https://notificationsounds.com/storage/sounds/file-sounds-1151-pristine.mp3"
          );
          audio.play().catch((err) => console.warn("Audio failed:", err));
        }
      });

      // =========================
      // TOGGLE CHAT POPUP
      // =========================
      function toggleChat() {
        const popup = document.getElementById("chatPopup");
        const chatNotifBadge = document.getElementById("chatNotifBadge");

        popup.classList.toggle("hidden");

        if (!popup.classList.contains("hidden")) {
          chatNotifBadge?.classList.add("hidden");
          chatNotifBadge.textContent = "0";
        }
      }

      // =========================
      // SHOW NOTIFICATION TOAST
      // =========================
      function showChatToast(message) {
        const toast = document.createElement("div");
        toast.style.top = "70px";

        toast.className = `
    fixed left-1/2 transform -translate-x-1/2 
    bg-white text-gray-800 px-4 py-3 rounded-2xl shadow-lg 
    border border-gray-300 z-50 flex items-center space-x-3 
    animate-toast-slide-down w-[340px] max-w-[90%]
  `;

        toast.innerHTML = `
    <div class="w-10 h-10 flex items-center justify-center bg-green-500 text-white rounded-full text-lg font-semibold">ðŸ’¬</div>
    <div>
      <p class="text-sm font-semibold text-green-600">Support Team</p>
      <p class="text-xs text-gray-700">${message}</p>
    </div>
  `;

        const style = document.createElement("style");
        style.textContent = `
    @keyframes toastSlideDown {
      from { opacity: 0; transform: translate(-50%, -40px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    .animate-toast-slide-down { animation: toastSlideDown 0.4s ease-out; }
  `;
        document.head.appendChild(style);

        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }
        </Script>
</body>
</html>