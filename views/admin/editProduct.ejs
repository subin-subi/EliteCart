<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Product</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@latest/dist/axios.min.js"></script>

</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Main Container -->
  <div class="max-w-5xl mx-auto bg-white p-8 mt-10 rounded-lg shadow-lg">
    <h1 class="text-2xl font-bold text-gray-700 mb-6">Edit Product</h1>

    <form id="editProductForm" class="space-y-6" enctype="multipart/form-data" method="POST" action="/admin/editProduct/<%= product._id %>">

      <!-- Product Details -->
      <div class="space-y-6">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Product Details</h2>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-600 mb-1">Product Name*</label>
              <input type="text" id="productName" name="name" 
                     class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                     placeholder="Enter product name" value="<%= product.name %>">
              <span id="errorName" class="text-red-500 text-sm"></span>
            </div>

            <div>
              <label class="block text-gray-600 mb-1">Brand*</label>
              <select id="productBrand" name="brand" 
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Select brand</option>
                <% if (brands && brands.length > 0) {%>
                  <% brands.forEach(brand => { %>
                    <option value="<%= brand._id %>" <%= String(product.brand._id) === String(brand._id) ? 'selected' : '' %>><%= brand.name %></option>

                  <% }) %>
                <% } %>
              </select>
              <span id="errorBrand" class="text-red-500 text-sm"></span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-gray-600 mb-1">Category*</label>
              <select id="productCategory" name="category" 
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Select category</option>
                <% if (categories && categories.length > 0) { %>
                  <% categories.forEach(category => { %>
                  <option value="<%= category._id %>" 
  <%= product.category && String(product.category._id) === String(category._id) ? 'selected' : '' %>>
  <%= category.name %>
</option>

                  <% }) %>
                <% } %>
              </select>
              <span id="errorCategory" class="text-red-500 text-sm"></span>
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-gray-600 mb-1">Product Description*</label>
            <textarea id="productDescription" name="description" rows="3" 
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                      placeholder="Enter product description"><%= product.description %></textarea>
            <span id="errorDescription" class="text-red-500 text-sm"></span>
          </div>
        </div>
      </div>

      <!-- Variants Section Header -->
      <div class="flex justify-between items-center mt-6">
        <h2 class="text-xl font-semibold text-gray-800">Variants*</h2>
        <button type="button" 
        onclick="addVariant('<%= product._id %>')" 
        class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
  + Add Variant
</button>

      </div>

      <!-- Variants -->
      <div class="space-y-6" id="variantsContainer">
  <% product.variants.forEach((variant, index) => { %>
    <div class="variant-row bg-white border border-gray-200 rounded-lg shadow-lg p-6 mb-6"
         data-variant-id="<%= variant._id %>">
      <div class="flex justify-between items-center mb-4">
        <h4 class="text-md font-medium text-gray-700">Variant <%= index + 1 %></h4>
       
      </div>

            <div class="grid grid-cols-3 gap-4 mb-6">
              <div>
                <label class="block text-gray-600 mb-1">Volume*</label>
                <select name="variants[<%= index %>][volume]" class="variant-volume w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">Select volume</option>
                  <option value="100" <%= variant.volume=='100' ? 'selected' : '' %>>100 ml</option>
                  <option value="250" <%= variant.volume=='250' ? 'selected' : '' %>>250 ml</option>
                  <option value="500" <%= variant.volume=='500' ? 'selected' : '' %>>500 ml</option>
                  <option value="750" <%= variant.volume=='750' ? 'selected' : '' %>>750 ml</option>
                  <option value="1000" <%= variant.volume=='1000' ? 'selected' : '' %>>1000 ml</option>
                </select>
              </div>

              <div>
                <label class="block text-gray-600 mb-1">Price*</label>
                <input type="number" name="variants[<%= index %>][price]" class="variant-price w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                       placeholder="Enter price" value="<%= variant.price %>" step="1">
              </div>

              <div>
                <label class="block text-gray-600 mb-1">Quantity*</label>
                <input type="number" name="variants[<%= index %>][stock]" class="variant-stock w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                       placeholder="Enter quantity" min="0" value="<%= variant.stock %>">
              </div>
            </div>

            <!-- Variant Images -->
  <div>


<div class="mb-6">
  <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Images</h3>

  <!-- Main Image Section -->
  <div class="mb-6">
    <label class="block text-gray-600 mb-2 font-medium">Main Image*</label>

    <div class="relative inline-block">
      <% if(variant.mainImage){ %>
        <img src="<%= variant.mainImage %>" 
             alt="Main Image" 
             class="w-32 h-32 object-cover rounded-lg cursor-pointer"
             onclick="editMainImage('<%= variant._id %>')">
      <% } else { %>
        <!-- Placeholder when no image -->
        <div class="w-32 h-32 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm">
          No Image
        </div>
      <% } %>
    </div>

    <!-- Add Main Image Button below the image -->
    <div class="mt-3">
      <button type="button" 
              onclick="document.getElementById('mainImageInput-<%= variant._id %>').click()" 
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
        Add Main Image
      </button>
    </div>

    <input type="file" name="variants[<%= index %>][mainImage]" 
           id="mainImageInput-<%= variant._id %>" 
           class="hidden" 
           accept="image/*"
           onchange="handleExistingMainImage(event, '<%= variant._id %>')">

    <div id="mainImagePreview-<%= variant._id %>" class="mt-3"></div>
  </div>
</div>
<!-- Sub Images Section -->
<div>
  <label class="block text-gray-600 mb-2 font-medium">Additional Images</label>

  <div class="flex flex-wrap gap-3 mb-3" id="subImagesContainer-<%= variant._id %>">
    <% if(variant.subImages && variant.subImages.length > 0){ %>
      <% variant.subImages.forEach((img, subIndex) => { %>
        <div class="relative w-20 h-20 subImageWrapper" 
             data-variant="<%= variant._id %>" 
             data-url="<%= img %>">
          <img src="<%= img %>" 
               class="w-20 h-20 object-cover rounded-lg cursor-pointer"
               onclick="editSubImage('<%= variant._id %>', <%= subIndex %>)">
          <button type="button" 
                  class="absolute top-0 right-0 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"
                  onclick="removeSubImage('<%= variant._id %>', '<%= img %>')">âœ•</button>
        </div>
      <% }) %>
    <% } %>
  </div>

  <button type="button" 
          onclick="document.getElementById('subImagesInput-<%= variant._id %>').click()" 
          class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
    Add Sub Images
  </button>

  <input type="file" 
       name="variants[<%= index %>][subImages]" 
       id="subImagesInput-<%= variant._id %>" 
       multiple class="hidden" 
       accept="image/*"
       onchange="handleExistingSubImages(event, '<%= variant._id %>', <%= variant.subImages ? variant.subImages.length : 0 %>)">

</div>

</div>
    </div>
        <% }) %>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-3 mt-4">
        <a href="/admin/products" 
           class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition inline-block text-center">
          Cancel
        </a>
        <button type="submit" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition">Update Product</button>
      </div>

    </form>
  </div>


<!-- ////////////////////////////////////////////////////////Crop Modal ///////////////////////////////////////////////////////////////// -->
   

     
  <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-80 items-center justify-center hidden z-50">
    <div class="bg-gray-900 p-6 rounded-2xl max-w-xl w-full border border-gray-800">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Crop Image</h2>
        <button onclick="closeCropModal()" class="text-gray-400 hover:text-white text-2xl font-bold transition-colors">&times;</button>
      </div>
      <div class="w-full h-96">
        <img id="cropImage" class="max-h-full w-full object-contain" />
      </div>
      <div class="text-center mt-4">
        <button onclick="cropAndSave()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-2 rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all duration-300">Crop & Save</button>
      </div>
    </div>
  </div>



  <!-- Scripts -->
  <script src="/javascript/admin/editProduct.js"></script>
</body>
</html>
