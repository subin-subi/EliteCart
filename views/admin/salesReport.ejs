<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>

<!-- Optional dark theme (looks great with your black background) -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css"
/>
  <!-- Bootstrap Bundle (JS + Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body >

<body class="bg-white text-black min-h-screen flex">

  <!-- Sidebar -->
  <div class="w-64 hidden md:block bg-black text-white p-4">
    <%- include('../partials/sidebar') %>
  </div>

  <!-- Main Content -->
  <div class="flex-1 p-6 space-y-6">
    <!-- Header -->
   <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
  <h2 class="text-2xl sm:text-3xl font-bold">Sales Report</h2>
  <div class="flex flex-wrap gap-2">
    <button onclick="downloadReport('pdf')" class="border border-black text-black px-4 py-2 rounded-lg hover:bg-black hover:text-white transition">
      <i class="bi bi-filetype-pdf"></i> Download Full Period PDF
    </button>
    <button onclick="downloadReport('excel')" class="border border-black text-black px-4 py-2 rounded-lg hover:bg-black hover:text-white transition">
      <i class="bi bi-filetype-csv"></i> Download Full Period Excel
    </button>
  </div>
</div>

    <!-- Filters -->
    <div class="bg-black text-white p-5 rounded-2xl">
      <div class="grid md:grid-cols-4 gap-4 items-end">
        <div>
          <label class="block mb-2">Range</label>
          <select id="range" onchange="toggleCustomDates()" class="w-full bg-white text-black border border-gray-400 rounded-lg px-3 py-2 focus:ring-2 focus:ring-gray-600">
            <option value="day" <%= range==='day'?'selected':'' %>>1 Day</option>
            <option value="week" <%= range==='week'?'selected':'' %>>1 Week</option>
            <option value="month" <%= range==='month'?'selected':'' %>>1 Month</option>
            <option value="year" <%= range==='year'?'selected':'' %>>1 Year</option>
            <option value="custom" <%= range==='custom'?'selected':'' %>>Custom</option>
          </select>
        </div>


<!-- Start Date -->
      <div>
        <label for="startDate" class="block mb-2 font-medium text-white">Start Date</label>
        <div class="relative">
          <input
            id="startDate"
            name="startDate"
            type="text"
            placeholder="Select start date"
            class="w-full bg-white text-black border border-gray-400 rounded-lg px-3 py-2 focus:ring-2 focus:ring-gray-600 focus:outline-none"
            autocomplete="off"
          />
          <i class="bi bi-calendar-date absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
        </div>
      </div>

      <!-- End Date -->
      <div>
        <label for="endDate" class="block mb-2 font-medium text-white">End Date</label>
        <div class="relative">
          <input
            id="endDate"
            name="endDate"
            type="text"
            placeholder="Select end date"
            class="w-full bg-white text-black border border-gray-400 rounded-lg px-3 py-2 focus:ring-2 focus:ring-gray-600 focus:outline-none"
            autocomplete="off"
          />
          <i class="bi bi-calendar-date absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
        </div>
      </div>

      <div class="flex gap-2">
  <!-- Apply Button -->
  <button
    onclick="applyFilters()"
    class="flex-1 border border-white bg-white text-black px-4 py-2 rounded-lg hover:bg-black hover:text-white transition font-medium"
  >
    <i class="bi bi-funnel"></i> Apply
  </button>

  <!-- Clear Button -->
  <button
    onclick="clearFilters()"
    class="border border-gray-500 bg-gray-100 text-black px-4 py-2 rounded-lg hover:bg-gray-800 hover:text-white transition font-medium"
  >
    <i class="bi bi-x-circle"></i> Clear
  </button>
</div>
    
      </div>
    </div>

    <!-- Metrics -->
    <div class="grid sm:grid-cols-3 gap-4">
      <div class="bg-black text-white p-4 rounded-2xl flex justify-between">
        <span>Overall Sales Count</span>
        <span class="font-bold"><%= metrics.count %></span>
      </div>

      <div class="bg-black text-white p-4 rounded-2xl flex justify-between">
        <span>Overall Order Amount</span>
        <span class="font-bold">₹<%= metrics.amount %></span>
      </div>

      <div class="bg-black text-white p-4 rounded-2xl flex justify-between">
        <span>Overall Discount</span>
        <span class="font-bold">₹<%= metrics.discount %></span>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-black text-white p-5 rounded-2xl overflow-x-auto">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="bg-gray-900 text-white">
            <th class="p-3">Order ID</th>
            <th class="p-3">Date</th>
            <th class="p-3">Customer</th>
            <th class="p-3">Payment</th>
            <th class="p-3">Status</th>
            <th class="p-3">Products</th>
            <th class="p-3">Subtotal</th>
            <th class="p-3">Discount</th>
            <th class="p-3">Shipping</th>
            <th class="p-3">Grand Total</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-600">
          <% orders.forEach(o => { %>
            <tr class="hover:bg-gray-800 transition">
              <td class="p-3 font-semibold"><%= o.orderId %></td>
              <td class="p-3"><%= new Date(o.createdAt).toLocaleString('en-IN') %></td>
              <td class="p-3">
                <% if (o.userId) { %>
                  <div><%= o.userId.name %></div>
                  <div class="text-gray-400 text-xs"><%= o.userId.email %></div>
                <% } else { %>
                  <div class="text-gray-400">[User Deleted]</div>
                <% } %>
              </td>
              <td class="p-3"><%= o.paymentMethod %></td>
              <td class="p-3"><%= o.orderStatus %></td>
              <td class="p-3 text-sm">
                <% o.items.forEach(item => { %>
                  <div><%= item.productId.name %> (Qty: <%= item.quantity %>)</div>
                <% }) %>
              </td>
              <td class="p-3">₹<%= o.subtotal %></td>
              <td class="p-3">₹<%= o.discount %></td>
              <td class="p-3">₹<%= o.shippingCharge %></td>
              <td class="p-3 font-semibold">₹<%= o.grandTotal %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="flex justify-between items-center mt-6 text-sm">
        <div>
          Page <%= currentPage %> of <%= totalPages %> (<%= totalOrders %> orders)
        </div>
        <div class="flex gap-2">
          <% if (currentPage > 1) { %>
            <a class="px-3 py-1 border border-white text-white rounded hover:bg-white hover:text-black transition"
              href="?<%- (()=>{ const p=new URLSearchParams({ ...Object.fromEntries(new URLSearchParams(urlQuery||'')), page:String(currentPage-1) }); return p.toString(); })() %>">Previous</a>
          <% } %>
          <% if (currentPage < totalPages) { %>
            <a class="px-3 py-1 border border-white text-white rounded hover:bg-white hover:text-black transition"
              href="?<%- (()=>{ const p=new URLSearchParams({ ...Object.fromEntries(new URLSearchParams(urlQuery||'')), page:String(currentPage+1) }); return p.toString(); })() %>">Next</a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>



  <script>

function toggleCustomDates() {
  const range = document.getElementById("range").value;
  const startDate = document.getElementById("startDate");
  const endDate = document.getElementById("endDate");

  const disabled = range !== "custom";

  startDate.disabled = disabled;
  endDate.disabled = disabled;

  // disable/enable flatpickr alt input
  const startAlt = startDate.nextElementSibling;
  const endAlt = endDate.nextElementSibling;

  if (startAlt) startAlt.disabled = disabled;
  if (endAlt) endAlt.disabled = disabled;

  if (disabled) {
    startAlt.classList.add("opacity-50", "pointer-events-none");
    endAlt.classList.add("opacity-50", "pointer-events-none");
  } else {
    startAlt.classList.remove("opacity-50", "pointer-events-none");
    endAlt.classList.remove("opacity-50", "pointer-events-none");
  }
}






//////////////////////////////////////////////////////////

 const normalizeDateForQuery = (value) => {
   if (!value) return "";
   const sanitized = value.includes("T") ? value : value.replace(" ", "T");
   const date = new Date(sanitized);
   if (Number.isNaN(date.getTime())) return "";
   return date.toISOString();
 };

 // Optional: Validate date format (YYYY-MM-DD)
  function validateDate(inputId) {
    const input = document.getElementById(inputId);
    input.addEventListener("blur", () => {
      const datePattern = /^\d{4}-\d{2}-\d{2}$/;
      if (input.value && !datePattern.test(input.value)) {
        alert("Please enter the date in YYYY-MM-DD format.");
        input.focus();
      }
    });
  }

  validateDate("startDate");
  validateDate("endDate");



/////////////////////////////////////////////////////////////////
    function applyFilters(){
      const params = new URLSearchParams();
      const range = document.getElementById('range').value;
      params.append('range', range);
      if (range === 'custom') {
    // Read actual values
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const s = startInput.getAttribute('data-value') || startInput.value;
    const e = endInput.getAttribute('data-value') || endInput.value;

    const startIso = normalizeDateForQuery(s);
    const endIso = normalizeDateForQuery(e);

    if (startIso) params.append('startDate', startIso);
    if (endIso) params.append('endDate', endIso);
  }
      window.location.href = '/admin/salesreport?' + params.toString();
    }

    function clearFilters(){
      window.location.href = '/admin/salesreport';
    }


    toggleCustomDates();

   async function downloadReport(type) {
    try {
      const params = new URLSearchParams(window.location.search);
      params.delete('page');
      params.delete('limit');

      // Build endpoint based on type
     const endpoint = type === 'pdf'
      ? '/admin/salesreport/download/pdf?' + params.toString()
      : '/admin/salesreport/download/excel?' + params.toString();


      const response = await fetch(endpoint);

      if (!response.ok) {
        throw new Error('Failed to download ' + type.toUpperCase());
      }

      // Convert response to Blob (binary file)
      const blob = await response.blob();

      // Create a temporary link element for download
      const link = document.createElement('a');
      const url = window.URL.createObjectURL(blob);
      link.href = url;

      // Set download filename
      const today = new Date().toISOString().split('T')[0];
      link.download = type === 'pdf'
        ? `EliteKart_SalesReport_${today}.pdf`
        : `EliteKart_SalesReport_${today}.xlsx`;

      // Trigger download
      document.body.appendChild(link);
      link.click();

      // Cleanup
      link.remove();
      window.URL.revokeObjectURL(url);

    } catch (error) {
      console.error('Download error:', error);
      alert('Something went wrong while downloading the file!');
    }
  }
  
  </script>

 <!-- Include Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
const startInput = document.getElementById("startDate");
const endInput = document.getElementById("endDate");

const startPicker = flatpickr(startInput, {
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  altInput: true,
  altFormat: "F j, Y - h:i K",
  allowInput: true,
  defaultHour: 0,
  defaultMinute: 0,
  maxDate: "today",
  onChange: function (selectedDates, dateStr) {
    startInput.setAttribute("data-value", dateStr);

    // Refresh end date limit dynamically
    endPicker.set("minDate", dateStr);
  }
});

const endPicker = flatpickr(endInput, {
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  altInput: true,
  altFormat: "F j, Y - h:i K",
  allowInput: true,
  defaultHour: 23,
  defaultMinute: 59,
  maxDate: "today",
  onChange: function (selectedDates, dateStr) {
    endInput.setAttribute("data-value", dateStr);

    // Refresh start date limit dynamically
    startPicker.set("maxDate", dateStr);
  }
});

</script>

</body>
</html>