<!-- Add Address Modal -->
<div id="addAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start pt-20 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md 
              max-h-[80vh] overflow-y-auto scrollbar-thin">

    <h3 class="text-lg font-semibold mb-4">Add Address</h3>

    <form id="addAddressForm" class="space-y-4">

      <!-- Name -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addName" placeholder="Full Name" class="w-full px-3 py-2 border rounded">
        <span id="errorAddName" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- House -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addHouse" placeholder="House Name" class="w-full px-3 py-2 border rounded">
        <span id="errorAddHouse" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Street -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addStreet" placeholder="Street" class="w-full px-3 py-2 border rounded">
        <span id="errorAddStreet" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- City -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addCity" placeholder="City" class="w-full px-3 py-2 border rounded">
        <span id="errorAddCity" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- State -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addState" placeholder="State" class="w-full px-3 py-2 border rounded">
        <span id="errorAddState" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Pincode -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addPincode" placeholder="Pincode" class="w-full px-3 py-2 border rounded">
        <span id="errorAddPincode" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Country -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addCountry" placeholder="Country" class="w-full px-3 py-2 border rounded">
        <span id="errorAddCountry" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Mobile -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addMobile" placeholder="Mobile Number" class="w-full px-3 py-2 border rounded">
        <span id="errorAddMobile" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-2 pt-4 sticky bottom-0 bg-white pb-2">
        <button type="button" onclick="closeAddModal()" class="px-3 py-1 bg-gray-200 rounded text-sm">Cancel</button>
        <button type="submit" class="px-3 py-1 bg-black text-white rounded text-sm">Save</button>
      </div>

    </form>
  </div>
</div>




<!-- Edit Address Modal -->
<div id="editAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start pt-20 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md 
              max-h-[80vh] overflow-y-auto scrollbar-thin">

    <h3 class="text-lg font-semibold mb-4">Edit Address</h3>

    <form id="editAddressForm" class="space-y-4">

      <input type="hidden" id="editAddressId">

      <!-- Full Name -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editName" placeholder="Full Name" 
               class="w-full px-3 py-2 border rounded">
        <span id="editNameError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- House -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editHouse" placeholder="House Name" 
               class="w-full px-3 py-2 border rounded">
        <span id="editHouseError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Street -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editStreet" placeholder="Street"
               class="w-full px-3 py-2 border rounded">
        <span id="editStreetError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- City -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editCity" placeholder="City"
               class="w-full px-3 py-2 border rounded">
        <span id="editCityError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- State -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editState" placeholder="State"
               class="w-full px-3 py-2 border rounded">
        <span id="editStateError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Pincode -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editPincode" placeholder="Pincode"
               class="w-full px-3 py-2 border rounded">
        <span id="editPincodeError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Country -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editCountry" placeholder="Country"
               class="w-full px-3 py-2 border rounded">
        <span id="editCountryError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Mobile -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editMobile" placeholder="Mobile Number"
               class="w-full px-3 py-2 border rounded">
        <span id="editMobileError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-2 pt-4 sticky bottom-0 bg-white pb-2">
        <button type="button" onclick="closeEditModal()" 
                class="px-3 py-1 bg-gray-200 rounded text-sm">Cancel</button>

        <button type="submit" 
                class="px-3 py-1 bg-black text-white rounded text-sm">Save</button>
      </div>

    </form>
  </div>
</div>

<script>
  // Close modals
  function closeAddModal() { document.getElementById('addAddressModal').classList.add('hidden'); }
  function closeEditModal() { document.getElementById('editAddressModal').classList.add('hidden'); }


document.getElementById('addAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // Clear previous errors
  const errorFields = [
    "errorAddName", "errorAddHouse", "errorAddStreet", "errorAddCity",
    "errorAddState", "errorAddPincode", "errorAddCountry", "errorAddMobile"
  ];

  errorFields.forEach(id => {
    const el = document.getElementById(id);
    el.textContent = "";
    el.classList.add("hidden");
  });

  const name = document.getElementById('addName').value.trim();
  const houseName = document.getElementById('addHouse').value.trim();
  const street = document.getElementById('addStreet').value.trim();
  const city = document.getElementById('addCity').value.trim();
  const state = document.getElementById('addState').value.trim();
  const pincode = document.getElementById('addPincode').value.trim();
  const country = document.getElementById('addCountry').value.trim();
  const mobile = document.getElementById('addMobile').value.trim();

  // Regex
  const nameRegex = /^[A-Za-z\s]{3,40}$/;
  const mobileRegex = /^[6-9]\d{9}$/;
  const pincodeRegex = /^\d{6}$/;

  let hasError = false;

  if (!name || !nameRegex.test(name)) {
    const el = document.getElementById("errorAddName");
    el.textContent = "Please enter a valid name (letters only, min 3 chars).";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (!houseName || houseName.length < 2) {
    const el = document.getElementById("errorAddHouse");
    el.textContent = "Please enter a valid house name.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (street && street.length < 3) {
    const el = document.getElementById("errorAddStreet");
    el.textContent = "Street must be at least 3 characters.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (!city || city.length < 2) {
    const el = document.getElementById("errorAddCity");
    el.textContent = "Please enter a valid city.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (!state || state.length < 2) {
    const el = document.getElementById("errorAddState");
    el.textContent = "Please enter a valid state.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (!pincode || !pincodeRegex.test(pincode)) {
    const el = document.getElementById("errorAddPincode");
    el.textContent = "Pincode must be a 6-digit number.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (!country || country.length < 2) {
    const el = document.getElementById("errorAddCountry");
    el.textContent = "Please enter a valid country.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (!mobile || !mobileRegex.test(mobile)) {
    const el = document.getElementById("errorAddMobile");
    el.textContent = "Enter a valid 10-digit mobile number starting 6â€“9.";
    el.classList.remove("hidden");
    hasError = true;
  }

  if (hasError) return;

  // Submit to backend
  const data = { name, houseName, street, city, state, pincode, country, mobile };

 try {
  const res = await axios.post('/add-Address', data);

  if (res.data.success) {
    Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
    }).fire({
      icon: 'success',
      title: 'Address added successfully!'
    });

    setTimeout(() => window.location.reload(), 2000);

  } else {
    Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
    }).fire({
      icon: 'error',
      title: res.data.message || 'Failed to add address!'
    });
  }

} catch (err) {
  console.error('Error adding address:', err);

  Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2000,
    timerProgressBar: true,
  }).fire({
    icon: 'error',
    title: 'Something went wrong!'
  });
}

});



  //////////////////////////// Prefill Edit form/////////////////////////
  
function editAddress(addr) {
  document.getElementById('editAddressId').value = addr._id;
  document.getElementById('editName').value = addr.name;
  document.getElementById('editHouse').value = addr.houseName;
  document.getElementById('editStreet').value = addr.street;
  document.getElementById('editCity').value = addr.city;
  document.getElementById('editState').value = addr.state;
  document.getElementById('editPincode').value = addr.pincode;
  document.getElementById('editCountry').value = addr.country;
  document.getElementById('editMobile').value = addr.mobile;

  // Reset previous errors
  document.querySelectorAll('#editAddressForm span').forEach(s => {
    s.textContent = "";
    s.classList.add("hidden");
  });

  document.getElementById('editAddressModal').classList.remove('hidden');
}


document.getElementById('editAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('editAddressId').value;
  
  const name = document.getElementById('editName').value.trim();
  const houseName = document.getElementById('editHouse').value.trim();
  const street = document.getElementById('editStreet').value.trim();
  const city = document.getElementById('editCity').value.trim();
  const state = document.getElementById('editState').value.trim();
  const pincode = document.getElementById('editPincode').value.trim();
  const country = document.getElementById('editCountry').value.trim();
  const mobile = document.getElementById('editMobile').value.trim();

  const errorFields = {
    name: document.getElementById('editNameError'),
    houseName: document.getElementById('editHouseError'),
    street: document.getElementById('editStreetError'),
    city: document.getElementById('editCityError'),
    state: document.getElementById('editStateError'),
    pincode: document.getElementById('editPincodeError'),
    country: document.getElementById('editCountryError'),
    mobile: document.getElementById('editMobileError')
  };

  // Clear previous errors
  Object.values(errorFields).forEach(span => {
    span.textContent = "";
    span.classList.add("hidden");
  });

  let isValid = true;

  // Validation patterns
  const onlyLetters = /^[A-Za-z ]{3,}$/;
  const housePattern = /^[A-Za-z0-9 .-]{3,}$/;

  // Full Name
  if (!onlyLetters.test(name)) {
    errorFields.name.textContent = "Enter a valid name (letters only, min 3 chars)";
    errorFields.name.classList.remove("hidden");
    isValid = false;
  }

  // House Name
  if (!housePattern.test(houseName)) {
    errorFields.houseName.textContent = "Enter a valid house name (letters/numbers allowed)";
    errorFields.houseName.classList.remove("hidden");
    isValid = false;
  }

  // Street
  if (street.length < 3) {
    errorFields.street.textContent = "Street must be at least 3 characters";
    errorFields.street.classList.remove("hidden");
    isValid = false;
  }

  // City
  if (!onlyLetters.test(city)) {
    errorFields.city.textContent = "Enter a valid city (letters only)";
    errorFields.city.classList.remove("hidden");
    isValid = false;
  }

  // State
  if (!onlyLetters.test(state)) {
    errorFields.state.textContent = "Enter a valid state (letters only)";
    errorFields.state.classList.remove("hidden");
    isValid = false;
  }

  // Pincode
  if (!/^\d{6}$/.test(pincode)) {
    errorFields.pincode.textContent = "Pincode must be exactly 6 digits";
    errorFields.pincode.classList.remove("hidden");
    isValid = false;
  }

  // Country
  if (!onlyLetters.test(country)) {
    errorFields.country.textContent = "Enter a valid country (letters only)";
    errorFields.country.classList.remove("hidden");
    isValid = false;
  }

  // Mobile
  if (!/^[6-9]\d{9}$/.test(mobile)) {
    errorFields.mobile.textContent = "Enter a valid 10-digit mobile number";
    errorFields.mobile.classList.remove("hidden");
    isValid = false;
  }

  if (!isValid) return;

  // Send Data
  const data = { name, houseName, street, city, state, pincode, country, mobile };

 try {
  const res = await axios.patch(`/edit-Address/${id}`, data);

  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2000,
    timerProgressBar: true,
  });

  if (res.data.success) {
    Toast.fire({
      icon: 'success',
      title: 'Address updated successfully!'
    });

    setTimeout(() => window.location.reload(), 2000);

  } else {
    Toast.fire({
      icon: 'error',
      title: res.data.message || 'Update failed!'
    });
  }

} catch (err) {
  console.error(err);

  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2000,
    timerProgressBar: true,
  });

  Toast.fire({
    icon: 'error',
    title: 'Something went wrong!'
  });
}

});

</script>
