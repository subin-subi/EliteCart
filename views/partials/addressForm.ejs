<!-- Add Address Modal -->
<div id="addAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start pt-20 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md 
              max-h-[80vh] overflow-y-auto scrollbar-thin">

    <h3 class="text-lg font-semibold mb-4">Add Address</h3>

    <form id="addAddressForm" class="space-y-4">

      <!-- Name -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addName" placeholder="Full Name" class="w-full px-3 py-2 border rounded">
        <span id="errorAddName" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- House -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addHouse" placeholder="House Name" class="w-full px-3 py-2 border rounded">
        <span id="errorAddHouse" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Street -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addStreet" placeholder="Street" class="w-full px-3 py-2 border rounded">
        <span id="errorAddStreet" class="text-red-500 text-xs hidden"></span>
      </div>

        <!-- Pincode -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addPincode" placeholder="Pincode" class="w-full px-3 py-2 border rounded">
        <span id="errorAddPincode" class="text-red-500 text-xs hidden"></span>
      </div>


      <!-- City -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addCity" placeholder="City" class="w-full px-3 py-2 border rounded">
        <span id="errorAddCity" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- State -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addState" placeholder="State" class="w-full px-3 py-2 border rounded">
        <span id="errorAddState" class="text-red-500 text-xs hidden"></span>
      </div>

      

      <!-- Country -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addCountry" placeholder="Country" class="w-full px-3 py-2 border rounded">
        <span id="errorAddCountry" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Mobile -->
      <div class="flex flex-col gap-1">
        <input type="text" id="addMobile" placeholder="Mobile Number" class="w-full px-3 py-2 border rounded">
        <span id="errorAddMobile" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-2 pt-4 sticky bottom-0 bg-white pb-2">
        <button type="button" onclick="closeAddModal()" class="px-3 py-1 bg-gray-200 rounded text-sm">Cancel</button>
        <button type="submit" class="px-3 py-1 bg-black text-white rounded text-sm">Save</button>
      </div>

    </form>
  </div>
</div>


<!-- //////////////////////////////edit  address model///////////////////////////////////////////// -->


<div id="editAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start pt-20 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md 
              max-h-[80vh] overflow-y-auto scrollbar-thin">

    <h3 class="text-lg font-semibold mb-4">Edit Address</h3>

    <form id="editAddressForm" class="space-y-4">

      <input type="hidden" id="editAddressId">

      <!-- Full Name -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editName" placeholder="Full Name" 
               class="w-full px-3 py-2 border rounded">
        <span id="editNameError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- House -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editHouse" placeholder="House Name" 
               class="w-full px-3 py-2 border rounded">
        <span id="editHouseError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Street -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editStreet" placeholder="Street"
               class="w-full px-3 py-2 border rounded">
        <span id="editStreetError" class="text-red-500 text-xs hidden"></span>
      </div>


         <!-- Pincode -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editPincode" placeholder="Pincode"
               class="w-full px-3 py-2 border rounded">
        <span id="editPincodeError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- City -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editCity" placeholder="City"
               class="w-full px-3 py-2 border rounded">
        <span id="editCityError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- State -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editState" placeholder="State"
               class="w-full px-3 py-2 border rounded">
        <span id="editStateError" class="text-red-500 text-xs hidden"></span>
      </div>

     

      <!-- Country -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editCountry" placeholder="Country"
               class="w-full px-3 py-2 border rounded">
        <span id="editCountryError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Mobile -->
      <div class="flex flex-col gap-1">
        <input type="text" id="editMobile" placeholder="Mobile Number"
               class="w-full px-3 py-2 border rounded">
        <span id="editMobileError" class="text-red-500 text-xs hidden"></span>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-2 pt-4 sticky bottom-0 bg-white pb-2">
        <button type="button" onclick="closeEditModal()" 
                class="px-3 py-1 bg-gray-200 rounded text-sm">Cancel</button>

        <button type="submit" 
                class="px-3 py-1 bg-black text-white rounded text-sm">Save</button>
      </div>

    </form>
  </div>
</div>

<script>
  // Close modals
  function closeAddModal() { document.getElementById('addAddressModal').classList.add('hidden'); }
  function closeEditModal() { document.getElementById('editAddressModal').classList.add('hidden'); }


  //////////////////////////////////////add address /////////////////////////////////////

document.getElementById('addAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // Clear previous errors
  const errorFields = [
    "errorAddName", "errorAddHouse", "errorAddStreet", "errorAddCity",
    "errorAddState", "errorAddPincode", "errorAddCountry", "errorAddMobile"
  ];
  errorFields.forEach(id => {
    const el = document.getElementById(id);
    el.textContent = "";
    el.classList.add("hidden");
  });

  // Get values
  const name = document.getElementById('addName').value.trim();
  const houseName = document.getElementById('addHouse').value.trim();
  const street = document.getElementById('addStreet').value.trim();
  const city = document.getElementById('addCity').value.trim();
  const state = document.getElementById('addState').value.trim();
  const pincode = document.getElementById('addPincode').value.trim();
  const country = document.getElementById('addCountry').value.trim();
  const mobile = document.getElementById('addMobile').value.trim();

  let hasError = false;

  // REGEX DEFINITIONS
  const nameRegex = /^[A-Za-z\s]{3,15}$/; // letters + spaces
  const houseRegex = /^[A-Za-z\s]{3,40}$/; // letters + spaces
  const streetRegex = /^[A-Za-z\s]{3,40}$/; // letters + spaces
  const cityStateRegex = /^[A-Za-z\s]{2,50}$/; // letters + spaces
  const pincodeRegex = /^\d{6}$/; // exactly 6 digits
  const countryRegex = /^[A-Za-z\s]{2,50}$/; // letters + spaces
  const mobileRegex = /^[6-9]\d{9}$/; // 10 digits starting 6–9

  // VALIDATIONS
  const validateField = (value, regex, errorId, errorMessage) => {
    const el = document.getElementById(errorId);
    if (!value) {
      el.textContent = "This field is required.";
      el.classList.remove("hidden");
      hasError = true;
      return;
    }
    if (!regex.test(value)) {
      el.textContent = errorMessage;
      el.classList.remove("hidden");
      hasError = true;
    }
  };

  validateField(name, nameRegex, "errorAddName", "Name must be 3- 15 letters only, no symbols.");
  validateField(houseName, houseRegex, "errorAddHouse", "House must be 2-50 characters, no symbols.");
  if (street) validateField(street, streetRegex, "errorAddStreet", "Street must be 3-100 characters, letters and numbers only.");
  validateField(city, cityStateRegex, "errorAddCity", "City must be 2-50 letters only, no symbols.");
  validateField(state, cityStateRegex, "errorAddState", "State must be 2-50 letters only, no symbols.");
  validateField(pincode, pincodeRegex, "errorAddPincode", "Pincode must be exactly 6 digits.");
  validateField(country, countryRegex, "errorAddCountry", "Country must be 2-50 letters only, no symbols.");
  validateField(mobile, mobileRegex, "errorAddMobile", "Mobile must be 10 digits starting 6–9.");

  if (hasError) return;

  // SUBMIT TO BACKEND
  const data = { name, houseName, street, city, state, pincode, country, mobile };

  try {
    const res = await axios.post('/add-Address', data);

    if (res.data.success) {
      Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
      }).fire({
        icon: 'success',
        title: 'Address added successfully!'
      });

      setTimeout(() => window.location.reload(), 2000);

    } else {
      Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
      }).fire({
        icon: 'error',
        title: res.data.message || 'Failed to add address!'
      });
    }

  } catch (err) {
    console.error('Error adding address:', err);

    Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
    }).fire({
      icon: 'error',
      title: 'Something went wrong!'
    });
  }
});



  //////////////////////////// Prefill Edit form/////////////////////////
  
function editAddress(addr) {
  document.getElementById('editAddressId').value = addr._id;
  document.getElementById('editName').value = addr.name;
  document.getElementById('editHouse').value = addr.houseName;
  document.getElementById('editStreet').value = addr.street;
  document.getElementById('editCity').value = addr.city;
  document.getElementById('editState').value = addr.state;
  document.getElementById('editPincode').value = addr.pincode;
  document.getElementById('editCountry').value = addr.country;
  document.getElementById('editMobile').value = addr.mobile;

  // Reset previous errors
  document.querySelectorAll('#editAddressForm span').forEach(s => {
    s.textContent = "";
    s.classList.add("hidden");
  });

  document.getElementById('editAddressModal').classList.remove('hidden');
}


document.getElementById('editAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('editAddressId').value;

  // Get trimmed values
  const name = document.getElementById('editName').value.trim();
  const houseName = document.getElementById('editHouse').value.trim();
  const street = document.getElementById('editStreet').value.trim();
  const city = document.getElementById('editCity').value.trim();
  const state = document.getElementById('editState').value.trim();
  const pincode = document.getElementById('editPincode').value.trim();
  const country = document.getElementById('editCountry').value.trim();
  const mobile = document.getElementById('editMobile').value.trim();

  const errorFields = {
    name: document.getElementById('editNameError'),
    houseName: document.getElementById('editHouseError'),
    street: document.getElementById('editStreetError'),
    city: document.getElementById('editCityError'),
    state: document.getElementById('editStateError'),
    pincode: document.getElementById('editPincodeError'),
    country: document.getElementById('editCountryError'),
    mobile: document.getElementById('editMobileError')
  };

  // Clear previous errors
  Object.values(errorFields).forEach(span => {
    span.textContent = "";
    span.classList.add("hidden");
  });

  let isValid = true;

  // Validation regex
  const onlyLetters = /^[A-Za-z\s]{2,15}$/; // letters + spaces
  const housePattern = /^[A-Za-z\s]{2,50}$/; // letters + spaces-
  const streetPattern =/^[A-Za-z\s]{2,50}$/; // letters + spaces
  const pincodePattern = /^\d{6}$/; // exactly 6 digits
  const mobilePattern = /^[6-9]\d{9}$/; // 10-digit starting 6–9
const cityStatePattern = /^[A-Za-z\s]{2,50}$/;
  // Helper function
  const validateField = (value, regex, field, message) => {
    if (!value) {
      errorFields[field].textContent = "This field is required.";
      errorFields[field].classList.remove("hidden");
      isValid = false;
      return;
    }
    if (!regex.test(value)) {
      errorFields[field].textContent = message;
      errorFields[field].classList.remove("hidden");
      isValid = false;
    }
  };

  validateField(name, onlyLetters, "name", "Name must be 2-15 letters, no symbols.");
  validateField(houseName, housePattern, "houseName", "House must be 2-50 chars, letters/numbers allowed.");
  if (street) validateField(street, streetPattern, "street", "Street must be 3-100 chars, letters/numbers allowed.");
  validateField(city, cityStatePattern, "city", "City must be 2-50 letters, no symbols.");
  validateField(state, cityStatePattern, "state", "State must be 2-50 letters, no symbols.");
  validateField(pincode, pincodePattern, "pincode", "Pincode must be exactly 6 digits.");
  validateField(country, onlyLetters, "country", "Country must be 2-50 letters, no symbols.");
  validateField(mobile, mobilePattern, "mobile", "Mobile must be 10 digits starting 6–9.");

  if (!isValid) return;

  // Submit data
  const data = { name, houseName, street, city, state, pincode, country, mobile };

  try {
    const res = await axios.patch(`/edit-Address/${id}`, data);

    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
    });

    if (res.data.success) {
      Toast.fire({ icon: 'success', title: 'Address updated successfully!' });
      setTimeout(() => window.location.reload(), 2000);
    } else {
      Toast.fire({ icon: 'error', title: res.data.message || 'Update failed!' });
    }

  } catch (err) {
    console.error(err);
    Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
    }).fire({ icon: 'error', title: 'Something went wrong!' });
  }
});


///////////////////////////////// add address pincode/////////////////////////////////////


document.addEventListener("DOMContentLoaded", () => {
    // ELEMENT REFERENCES
    const pincodeInput = document.getElementById("addPincode");
    const cityInput = document.getElementById("addCity");
    const stateInput = document.getElementById("addState");

    const pincodeError = document.getElementById("errorAddPincode");
    const cityError = document.getElementById("errorAddCity");
    const stateError = document.getElementById("errorAddState");

    // HELPER FUNCTION: Show error
    const showError = (element, message) => {
        element.textContent = message;
        element.classList.remove("hidden");
    };

    // HELPER FUNCTION: Hide error
    const hideError = (element) => {
        element.textContent = "";
        element.classList.add("hidden");
    };

    // PINCODE VALIDATION
    pincodeInput.addEventListener("input", async function () {
        const pincode = this.value.trim();
        hideError(pincodeError);
        cityInput.value = "";
        stateInput.value = "";

        // No symbols or whitespace
        if (!/^\d*$/.test(pincode)) {
            showError(pincodeError, "Pincode must contain numbers only.");
            return;
        }

        if (pincode.length > 0 && pincode.length < 6) {
            showError(pincodeError, "Pincode must be exactly 6 digits.");
            return;
        }

        if (pincode.length > 6) {
            showError(pincodeError, "Pincode cannot be more than 6 digits.");
            return;
        }

        // Fetch city/state for valid 6-digit pincode
        if (pincode.length === 6) {
            try {
                const res = await axios.get(`/get-location?pincode=${pincode}`);
                if (res.data.city && res.data.state) {
                    cityInput.value = res.data.city;
                    stateInput.value = res.data.state;
                } else {
                    showError(pincodeError, "Invalid or unavailable pincode.");
                }
            } catch (err) {
                showError(pincodeError, "Invalid or unavailable pincode.");
            }
        }
    });

    // CITY VALIDATION (Only letters, no symbols, no whitespace start/end)
    cityInput.addEventListener("input", function () {
        const city = this.value.trim();
        hideError(cityError);

        if (!/^[a-zA-Z\s]*$/.test(city)) {
            showError(cityError, "City must contain letters only.");
        }
        if (/^\s|\s$/.test(this.value)) {
            showError(cityError, "City cannot start or end with whitespace.");
        }
    });

    // STATE VALIDATION (Only letters, no symbols, no whitespace start/end)
    stateInput.addEventListener("input", function () {
        const state = this.value.trim();
        hideError(stateError);

        if (!/^[a-zA-Z\s]*$/.test(state)) {
            showError(stateError, "State must contain letters only.");
        }
        if (/^\s|\s$/.test(this.value)) {
            showError(stateError, "State cannot start or end with whitespace.");
        }
    });
});


////////////////////////////// edit address pincode //////////////////////////////

document.getElementById("editPincode").addEventListener("input", async function () {
    const pincode = this.value.trim();
    const pincodeError = document.getElementById("editPincodeError");
    const cityInput = document.getElementById("editCity");
    const stateInput = document.getElementById("editState");

    // Clear old errors when typing
    pincodeError.textContent = "";
    pincodeError.classList.add("hidden");

    // Clear autofilled city/state whenever pincode changes
    cityInput.value = "";
    stateInput.value = "";

    // Only digits allowed
    if (!/^\d*$/.test(pincode)) {
        pincodeError.textContent = "Pincode must contain numbers only.";
        pincodeError.classList.remove("hidden");
        return;
    }

    // Less than 6 digits
    if (pincode.length > 0 && pincode.length < 6) {
        pincodeError.textContent = "Pincode must be exactly 6 digits.";
        pincodeError.classList.remove("hidden");
        return;
    }

    // More than 6 digits
    if (pincode.length > 6) {
        pincodeError.textContent = "Pincode cannot be more than 6 digits.";
        pincodeError.classList.remove("hidden");
        return;
    }

    // If exactly 6 digits → call backend API
    if (pincode.length === 6) {
        try {
            const res = await axios.get(`/get-location?pincode=${pincode}`);

            if (res.data.city && res.data.state) {
                cityInput.value = res.data.city;
                stateInput.value = res.data.state;
            }
        } catch (err) {
            pincodeError.textContent = "Invalid or unavailable pincode.";
            pincodeError.classList.remove("hidden");
        }
    }
});




</script>
