<!-- Add Address Modal -->
<div id="addAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md mt-[120px] mb-[40px]">
    <h3 class="text-lg font-semibold mb-4">Add Address</h3>
    <form id="addAddressForm" class="space-y-3 mb-0">
      <input type="text" id="addName" placeholder="Full Name" class="w-full px-3 py-2 border rounded" required>
      <input type="text" id="addHouse" placeholder="House Name" class="w-full px-3 py-2 border rounded" required>
      <input type="text" id="addStreet" placeholder="Street" class="w-full px-3 py-2 border rounded">
      <input type="text" id="addCity" placeholder="City" class="w-full px-3 py-2 border rounded" required>
      <input type="text" id="addState" placeholder="State" class="w-full px-3 py-2 border rounded" required>
      <input type="text" id="addPincode" placeholder="Pincode" class="w-full px-3 py-2 border rounded" required>
      <input type="text" id="addCountry" placeholder="Country" class="w-full px-3 py-2 border rounded" required>
      <input type="text" id="addMobile" placeholder="Mobile Number" class="w-full px-3 py-2 border rounded" required>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" onclick="closeAddModal()" class="px-2 py-1 text-sm bg-gray-200 rounded">Cancel</button>
        <button type="submit" class="px-2 py-1 text-sm bg-black text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Address Modal -->
<div id="editAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md mt-[120px] mb-[40px]">
    <h3 class="text-lg font-semibold mb-4">Edit Address</h3>
    <form id="editAddressForm" class="space-y-3 mb-0">
      <input type="hidden" id="editAddressId">

      <div>
        <input type="text" id="editName" placeholder="Full Name" class="w-full px-3 py-2 border rounded" required>
        <span id="editNameError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editHouse" placeholder="House Name" class="w-full px-3 py-2 border rounded" required>
        <span id="editHouseError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editStreet" placeholder="Street" class="w-full px-3 py-2 border rounded">
        <span id="editStreetError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editCity" placeholder="City" class="w-full px-3 py-2 border rounded" required>
        <span id="editCityError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editState" placeholder="State" class="w-full px-3 py-2 border rounded" required>
        <span id="editStateError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editPincode" placeholder="Pincode" class="w-full px-3 py-2 border rounded" required>
        <span id="editPincodeError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editCountry" placeholder="Country" class="w-full px-3 py-2 border rounded" required>
        <span id="editCountryError" class="text-red-500 text-sm"></span>
      </div>

      <div>
        <input type="text" id="editMobile" placeholder="Mobile Number" class="w-full px-3 py-2 border rounded" required>
        <span id="editMobileError" class="text-red-500 text-sm"></span>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" onclick="closeEditModal()" class="px-2 py-1 text-sm bg-gray-200 rounded">Cancel</button>
        <button type="submit" class="px-2 py-1 text-sm bg-black text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Close modals
  function closeAddModal() { document.getElementById('addAddressModal').classList.add('hidden'); }
  function closeEditModal() { document.getElementById('editAddressModal').classList.add('hidden'); }


document.getElementById('addAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const name = document.getElementById('addName').value.trim();
  const houseName = document.getElementById('addHouse').value.trim();
  const street = document.getElementById('addStreet').value.trim();
  const city = document.getElementById('addCity').value.trim();
  const state = document.getElementById('addState').value.trim();
  const pincode = document.getElementById('addPincode').value.trim();
  const country = document.getElementById('addCountry').value.trim();
  const mobile = document.getElementById('addMobile').value.trim();

  // ðŸ§© Validation checks
  const nameRegex = /^[A-Za-z\s]{3,40}$/;
  const mobileRegex = /^[6-9]\d{9}$/;
  const pincodeRegex = /^\d{6}$/;

  if (!name || !nameRegex.test(name)) {
    return Swal.fire('Invalid Name', 'Please enter a valid full name (letters only, min 3 chars)', 'warning');
  }

  if (!houseName || houseName.length < 2) {
    return Swal.fire('Invalid House Name', 'Please enter a valid house name.', 'warning');
  }

  if (street && street.length < 3) {
    return Swal.fire('Invalid Street', 'Street name should be at least 3 characters.', 'warning');
  }

  if (!city || city.length < 2) {
    return Swal.fire('Invalid City', 'Please enter a valid city name.', 'warning');
  }

  if (!state || state.length < 2) {
    return Swal.fire('Invalid State', 'Please enter a valid state name.', 'warning');
  }

  if (!pincode || !pincodeRegex.test(pincode)) {
    return Swal.fire('Invalid Pincode', 'Pincode must be a 6-digit number.', 'warning');
  }

  if (!country || country.length < 2) {
    return Swal.fire('Invalid Country', 'Please enter a valid country name.', 'warning');
  }

  if (!mobile || !mobileRegex.test(mobile)) {
    return Swal.fire('Invalid Mobile Number', 'Enter a valid 10-digit mobile number starting from 6â€“9.', 'warning');
  }


  const data = { name, houseName, street, city, state, pincode, country, mobile };

  try {
    const res = await axios.post('/add-Address', data);
    if (res.data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Address added successfully!',
        timer: 2000,
        showConfirmButton: false,
      }).then(() => window.location.reload());
    } else {
      Swal.fire('Error', res.data.message || 'Failed to add address!', 'error');
    }
  } catch (err) {
    console.error('Error adding address:', err);
    Swal.fire('Error', 'Something went wrong while adding address!', 'error');
  }
});



  //////////////////////////// Prefill Edit form/////////////////////////
  
  function editAddress(addr) {
    document.getElementById('editAddressId').value = addr._id;
    document.getElementById('editName').value = addr.name;
    document.getElementById('editHouse').value = addr.houseName;
    document.getElementById('editStreet').value = addr.street;
    document.getElementById('editCity').value = addr.city;
    document.getElementById('editState').value = addr.state;
    document.getElementById('editPincode').value = addr.pincode;
    document.getElementById('editCountry').value = addr.country;
    document.getElementById('editMobile').value = addr.mobile;
    document.getElementById('editAddressModal').classList.remove('hidden');
  }

document.getElementById('editAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('editAddressId').value;
  const name = document.getElementById('editName').value.trim();
  const houseName = document.getElementById('editHouse').value.trim();
  const street = document.getElementById('editStreet').value.trim();
  const city = document.getElementById('editCity').value.trim();
  const state = document.getElementById('editState').value.trim();
  const pincode = document.getElementById('editPincode').value.trim();
  const country = document.getElementById('editCountry').value.trim();
  const mobile = document.getElementById('editMobile').value.trim();

  const errorFields = {
    name: document.getElementById('editNameError'),
    houseName: document.getElementById('editHouseError'),
    street: document.getElementById('editStreetError'),
    city: document.getElementById('editCityError'),
    state: document.getElementById('editStateError'),
    pincode: document.getElementById('editPincodeError'),
    country: document.getElementById('editCountryError'),
    mobile: document.getElementById('editMobileError')
  };

  Object.values(errorFields).forEach(span => span.textContent = "");

  let isValid = true;

  // Patterns
  const namePattern = /^[A-Za-z]{3,}(?: [A-Za-z]+)*$/; // only letters and single spaces, min 3 letters
  const housePattern = /^[A-Za-z0-9\s.-]{3,}$/;        // letters, numbers, dot, hyphen, space allowed
  const cityPattern = /^[A-Za-z\s]{3,}$/;
  const statePattern = /^[A-Za-z\s]{3,}$/;
  const countryPattern = /^[A-Za-z\s]{3,}$/;

  // Name
  if (!namePattern.test(name)) {
    errorFields.name.textContent = "Enter a valid name (min 3 letters, no numbers/symbols)";
    isValid = false;
  }

  // House Name
  if (!housePattern.test(houseName)) {
    errorFields.houseName.textContent = "Enter a valid house name (min 3 chars)";
    isValid = false;
  }

  // Street (optional but check format if provided)
  if (street && street.length < 3) {
    errorFields.street.textContent = "Street name must be at least 3 characters";
    isValid = false;
  }

  // City
  if (!cityPattern.test(city)) {
    errorFields.city.textContent = "Enter a valid city name (min 3 letters)";
    isValid = false;
  }

  // State
  if (!statePattern.test(state)) {
    errorFields.state.textContent = "Enter a valid state name (min 3 letters)";
    isValid = false;
  }

  // Pincode
  if (!/^\d{6}$/.test(pincode)) {
    errorFields.pincode.textContent = "Pincode must be exactly 6 digits";
    isValid = false;
  }

  // Country
  if (!countryPattern.test(country)) {
    errorFields.country.textContent = "Enter a valid country name (min 3 letters)";
    isValid = false;
  }

  // Mobile
  if (!/^[6-9]\d{9}$/.test(mobile)) {
    errorFields.mobile.textContent = "Enter a valid 10-digit mobile number starting from 6-9";
    isValid = false;
  }

  if (!isValid) return;

  // âœ… Send Request
  const data = { name, houseName, street, city, state, pincode, country, mobile };

  try {
    const res = await axios.patch(`/edit-Address/${id}`, data);
    if (res.data.success) {
      Swal.fire('Success', 'Address updated successfully!', 'success').then(() => {
        window.location.reload();
      });
    } else {
      Swal.fire('Error', res.data.message || 'Update failed', 'error');
    }
  } catch (err) {
    console.error(err);
    Swal.fire('Error', 'Something went wrong!', 'error');
  }
});

</script>
